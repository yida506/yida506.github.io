<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yida506.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="spider">
<meta property="og:url" content="http://yida506.github.io/index.html">
<meta property="og:site_name" content="spider">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Lan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yida506.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>spider</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">spider</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/21/%E6%8A%96%E9%9F%B3web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/21/%E6%8A%96%E9%9F%B3web/" class="post-title-link" itemprop="url">抖音web</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>服务器:101.43.104.49</p>
<p>账号:root</p>
<p>密码:Lan990918</p>
<p>mysql+redis</p>
<h4 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h4><p>需要建立三次握手，断开需要建立四次握手。</p>
<p><img src="/2022/03/21/%E6%8A%96%E9%9F%B3web/image-20220326225236374.png" alt="image-20220326225236374"></p>
<p>连接过程：Client(客户端)发送连接请求SYN报文，Server段接受连接后回复ACK报文，然后分配资源，客户端接收ACK报文后，也向服务端发送ACK报文，分配资源，然后就建立了TCP连接</p>
<p>断开连接：客户端发送FIN报文，假如数据还没传完，服务端继续发送ACK报文，之后在发送FIN报文给客户端，然后客户端再发ACK报文回来(告诉服务器可以关闭了)，然后就关闭了TCP连接。</p>
<h4 id="WebSocket协议"><a href="#WebSocket协议" class="headerlink" title="WebSocket协议"></a>WebSocket协议</h4><p>实现了浏览器与服务器全双工通信(full-duplex)。只需要建立一次连接，就可以一直保持连接状态，并且前后端可以互相通信，不再是单向的了。</p>
<blockquote>
<p>简单来讲，就是可以直接搭建起双向连接机制，</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/egrep/p/9546275.html">WebSocket的原理,及如何测试websocket是否连接成功 - Egrep - 博客园 (cnblogs.com)</a></p>
<h4 id="目标网站"><a href="#目标网站" class="headerlink" title="目标网站"></a>目标网站</h4><p><a target="_blank" rel="noopener" href="https://www.douyin.com/user/MS4wLjABAAAAeHJ41sMLJQv06KFI-PyqxocoipBl5AKhEV8EROp7HZU">https://www.douyin.com/user/MS4wLjABAAAAeHJ41sMLJQv06KFI-PyqxocoipBl5AKhEV8EROp7HZU</a></p>
<p>RPC注入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SekiroClient</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.wsURL = wsURL;</span><br><span class="line">    <span class="built_in">this</span>.handlers = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.socket = &#123;&#125;;</span><br><span class="line">    <span class="comment">// check</span></span><br><span class="line">    <span class="keyword">if</span> (!wsURL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;wsURL can not be empty!!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.webSocketFactory = <span class="built_in">this</span>.resolveWebSocketFactory();</span><br><span class="line">    <span class="built_in">this</span>.connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.resolveWebSocketFactory = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> theWebSocket = <span class="built_in">window</span>.WebSocket ? <span class="built_in">window</span>.WebSocket : <span class="built_in">window</span>.MozWebSocket;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">WindowWebSocketWrapper</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket = <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.close = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.close();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">onMessageFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onmessage = onMessageFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">onOpenFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onopen = onOpenFunction;</span><br><span class="line">            &#125;;</span><br><span class="line">            WindowWebSocketWrapper.prototype.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">onCloseFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onclose = onCloseFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.send(message);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowWebSocketWrapper(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> weex === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// this is weex env : https://weex.apache.org/zh/docs/modules/websockets.html</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;test webSocket for weex&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> ws = weex.requireModule(<span class="string">&#x27;webSocket&#x27;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;find webSocket for weex:&quot;</span> + ws);</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ws.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                ws.WebSocket(wsURL, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> ws;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(e);</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO support ReactNative</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> WebSocket === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weex å’Œ PCçŽ¯å¢ƒçš„websocket APIä¸å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥åšäº†æŠ½è±¡å…¼å®¹</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;the js environment do not support websocket&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.connect = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: begin of connect to wsURL: &#x27;</span> + <span class="built_in">this</span>.wsURL);</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">// ä¸check closeï¼Œè®©</span></span><br><span class="line">    <span class="comment">// if (this.socket &amp;&amp; this.socket.readyState === 1) &#123;</span></span><br><span class="line">    <span class="comment">//     this.socket.close();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = <span class="built_in">this</span>.webSocketFactory(<span class="built_in">this</span>.wsURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: create connection failed,reconnect after 2s&quot;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onmessage(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        _this.handleSekiroRequest(event.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onopen(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: open a sekiro client connection&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onclose(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: disconnected ,reconnection after 2s&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.handleSekiroRequest = <span class="function"><span class="keyword">function</span> (<span class="params">requestJson</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;receive sekiro request: &quot;</span> + requestJson);</span><br><span class="line">    <span class="keyword">var</span> request = <span class="built_in">JSON</span>.parse(requestJson);</span><br><span class="line">    <span class="keyword">var</span> seq = request[<span class="string">&#x27;__sekiro_seq__&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!request[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;need request param &#123;action&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> action = request[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.handlers[action]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;no action handler: &#x27;</span> + action + <span class="string">&#x27; defined&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> theHandler = <span class="built_in">this</span>.handlers[action];</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        theHandler(request, <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                _this.sendSuccess(seq, response)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                _this.sendFailed(seq, <span class="string">&quot;e:&quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">errorMessage</span>) </span>&#123;</span><br><span class="line">            _this.sendFailed(seq, errorMessage)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;error: &quot;</span> + e);</span><br><span class="line">        _this.sendFailed(seq, <span class="string">&quot;:&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendSuccess = <span class="function"><span class="keyword">function</span> (<span class="params">seq, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> responseJson;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseJson = <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            responseJson = &#123;&#125;;</span><br><span class="line">            responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        responseJson = response;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson = &#123;&#125;;</span><br><span class="line">        responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(responseJson)) &#123;</span><br><span class="line">        responseJson = &#123;</span><br><span class="line">            <span class="attr">data</span>: responseJson,</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseJson[<span class="string">&#x27;code&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;code&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseJson[<span class="string">&#x27;status&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendFailed = <span class="function"><span class="keyword">function</span> (<span class="params">seq, errorMessage</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> errorMessage != <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        errorMessage = <span class="built_in">JSON</span>.stringify(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> responseJson = &#123;&#125;;</span><br><span class="line">    responseJson[<span class="string">&#x27;message&#x27;</span>] = errorMessage;</span><br><span class="line">    responseJson[<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.registerAction = <span class="function"><span class="keyword">function</span> (<span class="params">action, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;an action must be string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handler !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;a handler must be function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: register action: &quot;</span> + action);</span><br><span class="line">    <span class="built_in">this</span>.handlers[action] = handler;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">S4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                  <span class="keyword">return</span> (((<span class="number">1</span>+<span class="built_in">Math</span>.random())*<span class="number">0x10000</span>)|<span class="number">0</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (S4()+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+S4()+S4());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> SekiroClient(<span class="string">&quot;ws://127.0.0.1:5620/business-demo/register?group=dy&amp;clientId=&quot;</span>+guid());</span><br><span class="line"></span><br><span class="line">client.registerAction(<span class="string">&quot;getSignature&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">request, resolve,reject </span>)</span>&#123;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">let</span> pageurl = <span class="string">&#x27;/aweme/v1/web/aweme/post/?device_platform=webapp&amp;aid=6383&amp;channel=channel_pc_web&amp;sec_user_id=MS4wLjABAAAAGyky76MpsaNiuI6tNX0dogABIPR8P_Od0YV7cGD_9P0&amp;max_cursor=1645674431000&amp;locate_query=false&amp;count=10&amp;publish_video_strategy_type=2&amp;version_code=170400&amp;version_name=17.4.0&amp;cookie_enabled=true&amp;screen_width=1920&amp;screen_height=1080&amp;browser_language=en-US&amp;browser_platform=Win32&amp;browser_name=Chrome&amp;browser_version=99.0.4844.74&amp;browser_online=true&amp;engine_name=Blink&amp;engine_version=99.0.4844.74&amp;os_name=Windows&amp;os_version=10&amp;cpu_core_num=8&amp;device_memory=8&amp;platform=PC&amp;downlink=10&amp;effective_type=4g&amp;round_trip_time=50&amp;webid=7077786468781164044&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendAjax</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest;</span><br><span class="line"></span><br><span class="line">                xhr.responseType = <span class="string">&quot;json&quot;</span>;</span><br><span class="line">                xhr.open(<span class="string">&#x27;get&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">                xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">                    resolve(xhr[<span class="string">&#x27;response&#x27;</span>][<span class="string">&#x27;aweme_list&#x27;</span>]);</span><br><span class="line">                    <span class="keyword">if</span>( <span class="built_in">this</span>.status == <span class="number">200</span> || <span class="built_in">this</span>.status == <span class="number">304</span>)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(xhr.responseURL);</span><br><span class="line">                            <span class="built_in">console</span>.log(xhr.responseType);</span><br><span class="line">                            <span class="keyword">return</span> xhr[<span class="string">&#x27;response&#x27;</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                xhr.send(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sendAjax(pageurl);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多线程</p>
<p>分布式</p>
<p>websocket</p>
<p>TCP </p>
<p>任务防丢</p>
<p>断点续爬 </p>
<p>HTTP协议</p>
<p>周期爬取</p>
<p>打假</p>
<p>分析（热门，竟对)</p>
<p>框架对比，</p>
<p>Scrapy feapder request</p>
<p>聚焦网络爬虫</p>
<p>搜索引擎爬虫</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/20/jsrpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/20/jsrpc/" class="post-title-link" itemprop="url">jsrpc</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="JSRPC"><a href="#JSRPC" class="headerlink" title="JSRPC"></a>JSRPC</h4><p>安装websocket服务</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> nodejs-websocket</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="built_in">require</span>(<span class="string">&quot;nodejs-websocket&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> _server = ws.createServer(<span class="function"><span class="params">conn</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 接收客户端返回的数据</span></span><br><span class="line">	conn.on(<span class="string">&quot;text&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(str, <span class="string">&quot;接收客户端传过来的值&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端关闭连接</span></span><br><span class="line">	conn.on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	conn.on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">		<span class="comment">//error</span></span><br><span class="line">		<span class="built_in">console</span>.log(err, <span class="string">&quot;连接报错&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8015</span>;</span><br><span class="line">_server.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;连接成功&quot;</span>)</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;listening on websocketServer&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>建立连接后，就可以用python和浏览器来回传递信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">ws = websocket.WebSocketApp(<span class="string">&#x27;ws://127.0.0.1:8015&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">ws, message</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message.split(<span class="string">&#x27;_&#x27;</span>)[<span class="number">0</span>] != <span class="string">&#x27;js&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">ws.on_message = on_message</span><br><span class="line">ws.run_forever()</span><br></pre></td></tr></table></figure>
<p>浏览器注入，建立通信</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket)&#123;</span><br><span class="line">		ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://127.0.0.1:8015/&#x27;</span>);</span><br><span class="line">		ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;服务器关闭&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;连接出错&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e)</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>注入后和js的websocketServer建立了双向连接，然后就形成了通信。</p>
<p><img src="/2022/03/20/jsrpc/image-20220320171420496.png" alt="image-20220320171420496"></p>
<p>这样，就可以在浏览器中通过send，进行调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SekiroClient</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.wsURL = wsURL;</span><br><span class="line">    <span class="built_in">this</span>.handlers = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.socket = &#123;&#125;;</span><br><span class="line">    <span class="comment">// check</span></span><br><span class="line">    <span class="keyword">if</span> (!wsURL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;wsURL can not be empty!!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.webSocketFactory = <span class="built_in">this</span>.resolveWebSocketFactory();</span><br><span class="line">    <span class="built_in">this</span>.connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.resolveWebSocketFactory = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> theWebSocket = <span class="built_in">window</span>.WebSocket ? <span class="built_in">window</span>.WebSocket : <span class="built_in">window</span>.MozWebSocket;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">WindowWebSocketWrapper</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket = <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.close = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.close();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">onMessageFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onmessage = onMessageFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">onOpenFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onopen = onOpenFunction;</span><br><span class="line">            &#125;;</span><br><span class="line">            WindowWebSocketWrapper.prototype.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">onCloseFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onclose = onCloseFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.send(message);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowWebSocketWrapper(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> weex === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// this is weex env : https://weex.apache.org/zh/docs/modules/websockets.html</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;test webSocket for weex&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> ws = weex.requireModule(<span class="string">&#x27;webSocket&#x27;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;find webSocket for weex:&quot;</span> + ws);</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ws.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                ws.WebSocket(wsURL, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> ws;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(e);</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO support ReactNative</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> WebSocket === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weex å’Œ PCçŽ¯å¢ƒçš„websocket APIä¸å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥åšäº†æŠ½è±¡å…¼å®¹</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;the js environment do not support websocket&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.connect = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: begin of connect to wsURL: &#x27;</span> + <span class="built_in">this</span>.wsURL);</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">// ä¸check closeï¼Œè®©</span></span><br><span class="line">    <span class="comment">// if (this.socket &amp;&amp; this.socket.readyState === 1) &#123;</span></span><br><span class="line">    <span class="comment">//     this.socket.close();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = <span class="built_in">this</span>.webSocketFactory(<span class="built_in">this</span>.wsURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: create connection failed,reconnect after 2s&quot;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onmessage(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        _this.handleSekiroRequest(event.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onopen(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: open a sekiro client connection&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onclose(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: disconnected ,reconnection after 2s&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.handleSekiroRequest = <span class="function"><span class="keyword">function</span> (<span class="params">requestJson</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;receive sekiro request: &quot;</span> + requestJson);</span><br><span class="line">    <span class="keyword">var</span> request = <span class="built_in">JSON</span>.parse(requestJson);</span><br><span class="line">    <span class="keyword">var</span> seq = request[<span class="string">&#x27;__sekiro_seq__&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!request[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;need request param &#123;action&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> action = request[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.handlers[action]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;no action handler: &#x27;</span> + action + <span class="string">&#x27; defined&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> theHandler = <span class="built_in">this</span>.handlers[action];</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        theHandler(request, <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                _this.sendSuccess(seq, response)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                _this.sendFailed(seq, <span class="string">&quot;e:&quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">errorMessage</span>) </span>&#123;</span><br><span class="line">            _this.sendFailed(seq, errorMessage)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;error: &quot;</span> + e);</span><br><span class="line">        _this.sendFailed(seq, <span class="string">&quot;:&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendSuccess = <span class="function"><span class="keyword">function</span> (<span class="params">seq, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> responseJson;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseJson = <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            responseJson = &#123;&#125;;</span><br><span class="line">            responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        responseJson = response;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson = &#123;&#125;;</span><br><span class="line">        responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(responseJson)) &#123;</span><br><span class="line">        responseJson = &#123;</span><br><span class="line">            <span class="attr">data</span>: responseJson,</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseJson[<span class="string">&#x27;code&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;code&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseJson[<span class="string">&#x27;status&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendFailed = <span class="function"><span class="keyword">function</span> (<span class="params">seq, errorMessage</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> errorMessage != <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        errorMessage = <span class="built_in">JSON</span>.stringify(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> responseJson = &#123;&#125;;</span><br><span class="line">    responseJson[<span class="string">&#x27;message&#x27;</span>] = errorMessage;</span><br><span class="line">    responseJson[<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.registerAction = <span class="function"><span class="keyword">function</span> (<span class="params">action, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;an action must be string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handler !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;a handler must be function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: register action: &quot;</span> + action);</span><br><span class="line">    <span class="built_in">this</span>.handlers[action] = handler;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">S4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                  <span class="keyword">return</span> (((<span class="number">1</span>+<span class="built_in">Math</span>.random())*<span class="number">0x10000</span>)|<span class="number">0</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (S4()+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+S4()+S4());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> SekiroClient(<span class="string">&quot;ws://127.0.0.1:5620/business-demo/register?group=ws-group&amp;clientId=&quot;</span>+guid());</span><br><span class="line"></span><br><span class="line">client.registerAction(<span class="string">&quot;clientTime&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">request, resolve,reject </span>)</span>&#123;</span><br><span class="line">            <span class="comment">//在这里div</span></span><br><span class="line">            resolve(<span class="string">&quot;&quot;</span>+<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sekiro框架注入Js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5620/business-demo/invoke?group=****&amp;action=****&amp;page=(这里选用要传的值)</span><br></pre></td></tr></table></figure>
<p>这里的group对应上面的组，action对应其调用的方法，这里是clientTime;</p>
<p>若要传值，可以采用类似python</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/13/ali/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/ali/" class="post-title-link" itemprop="url">ali</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 id="三重控制流平坦化"><a href="#三重控制流平坦化" class="headerlink" title="三重控制流平坦化"></a>三重控制流平坦化</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> e = <span class="number">1</span>; <span class="keyword">void</span> <span class="number">0</span> !== e;) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">7</span> &amp; e;</span><br><span class="line">    <span class="keyword">var</span> r = e &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="number">7</span> &amp; r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (a) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">switch</span> (s) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            i += <span class="string">&quot;a&quot;</span>;</span><br><span class="line">            e = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (i) &#123;</span><br><span class="line">              e = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              e = <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            i += <span class="string">&quot;hB&quot;</span>;</span><br><span class="line">            e = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">var</span> c = <span class="string">&quot;egdirbsj&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> b = c.split(<span class="string">&quot;&quot;</span>).reverse().join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> k = j[b];</span><br><span class="line">        <span class="keyword">var</span> o = !k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (o) &#123;</span><br><span class="line">          e = <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        i += <span class="string">&quot;ck&quot;</span>;</span><br><span class="line">        d(<span class="number">15</span>, <span class="number">0</span>, k, i, t);</span><br><span class="line">        <span class="keyword">return</span> !<span class="number">0</span>;</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">var</span> t = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> a = e[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">var</span> r = <span class="string">&quot;\u03a2\u03c3\u03b7\u03de\u03a8\u03cd\u03f7&quot;</span>;</span><br><span class="line">          <span class="keyword">var</span> s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          <span class="keyword">var</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> b = <span class="number">0</span>; b &lt; r.length; b++) &#123;</span><br><span class="line">            b || (c = <span class="number">972</span>);</span><br><span class="line">            <span class="keyword">var</span> k = r.charCodeAt(b);</span><br><span class="line">            <span class="keyword">var</span> o = k ^ c;</span><br><span class="line">            c = k;</span><br><span class="line">            s += <span class="built_in">String</span>.fromCharCode(o);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> t = a === s;</span><br><span class="line">          t &amp;&amp; d(<span class="number">0</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> i = <span class="string">&quot;pus&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i) &#123;</span><br><span class="line">          e = <span class="number">16</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">var</span> n = <span class="string">&quot;def&quot;</span>;</span><br><span class="line">        n += <span class="string">&quot;ault&quot;</span>;</span><br><span class="line">        k = k[n];</span><br><span class="line">        <span class="keyword">var</span> h = !k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (h) &#123;</span><br><span class="line">          e = <span class="number">6</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述为其模型的典型特征。</p>
<p>通过分析，我们可以发现，其中for循环中的test语句，为判断这个循环是否停止的条件，我们知道要使得for循环停止，可以添加break语句或者通过外嵌函数的方法，直接return出来，在这里我们可以看到，采用的是第二种方法，也就是说，在还原碰到return语句的时候，作为结束条件停止即可。</p>
<p><strong>大变量:指代这里的e</strong> </p>
<p><strong>初始化参数:指代这里的a、r、s</strong></p>
<ol>
<li><p>获取条件test表达式，获取初始化参数的值。</p>
</li>
<li><p>访问到最底部的节点，然后通过遍历的方式，获取其赋值语句，这里又分为两种情况：a.在当前层数可以找到最顶部参数的赋值语句的地方 b.在当前层数只能找到其上一节点的参数的赋值地方(应对多重switch嵌套)。</p>
<blockquote>
<p>思路，从初始for循环出发，初始化变量的值，然后根据SwitchStatement获取到当前变量及其对应的值，然后进入到case节点的位置，这里需要进行一个判断，判断其下一层是否还是SwitchStatemen类型，如果不是，那么就进行节点的合并，在这里面一定会包含一个关于初始值变化的位置，因此需要在这些Expressionstatement中找到其赋值表达式(Assignmentexpression)，然后在进行一次计算，但是在这种情况下，难免会碰到更深层的SwitchStatement，当游走到最深处的时候，需要判断，其是走向该Switch节点下的其他部分，还是赋值了大变量走入其他分支，最后根据return或者是结束语句判断是是否该for循环结束。</p>
</blockquote>
<p><strong>核心思路：将初始化和判断语句写入一个函数，这样可以做到一次获取全部初始变量的值，将所有的Switch节点均写为一个类似字典的形式，方便进入对应的节点。</strong> </p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_other_expression</span>(<span class="params">arr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temparr = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> arr)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!types.isSwitchStatement(i))&#123;</span><br><span class="line">            temparr.push(i);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> temparr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_switch_expression</span>(<span class="params">arr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> arr)&#123;</span><br><span class="line">        <span class="keyword">if</span>(types.isSwitchStatement(i))&#123;</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_switch_obj</span>(<span class="params">SwitchNode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> CaseNode = SwitchNode.cases;</span><br><span class="line">    <span class="keyword">let</span> current_obj = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> CaseNode)&#123;</span><br><span class="line">        <span class="comment">//如果节点里为SwitchStatement</span></span><br><span class="line">        <span class="keyword">if</span>(get_switch_expression(i.consequent))&#123;</span><br><span class="line">            current_obj[i.test.value] = get_switch_obj(get_switch_expression(i.consequent));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            current_obj[i.test.value] = i.consequent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> current_obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">return_obj_create</span>(<span class="params">init_expression, init_params_body</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temparr = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> exp <span class="keyword">of</span> init_params_body)&#123;</span><br><span class="line">        temparr.push(types.objectProperty(types.stringLiteral(exp.declarations[<span class="number">0</span>].id.name), exp.declarations[<span class="number">0</span>].id));</span><br><span class="line">    &#125;;</span><br><span class="line">    temparr.push(types.objectProperty(types.stringLiteral(init_expression.declarations[<span class="number">0</span>].id.name), init_expression.declarations[<span class="number">0</span>].id));</span><br><span class="line">    <span class="keyword">let</span> now_obj = types.objectExpression(temparr);</span><br><span class="line">    <span class="keyword">return</span> now_obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//游走到最底层节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_lowest_node</span>(<span class="params">init_value,SwitchNode, SwitchObj</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//给定初始对象</span></span><br><span class="line">    <span class="keyword">let</span> test_var = SwitchNode.discriminant.name;</span><br><span class="line">    <span class="comment">//获取当前对象的初始值</span></span><br><span class="line">    <span class="keyword">let</span> now_case_value = init_value[test_var];</span><br><span class="line">    <span class="comment">//进入最底层</span></span><br><span class="line">    <span class="keyword">let</span> now_node;</span><br><span class="line">    <span class="keyword">if</span>(types.isSwitchStatement(SwitchNode.cases[now_case_value].consequent[<span class="number">0</span>]))&#123;</span><br><span class="line">        <span class="comment">// console.log(generator(SwitchNode.cases[now_case_value].consequent[0]).code);</span></span><br><span class="line">        now_node = get_lowest_node(init_value, SwitchNode.cases[now_case_value].consequent[<span class="number">0</span>], SwitchObj[now_case_value])</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        now_node = SwitchObj[now_case_value];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> now_node;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_source_value</span>(<span class="params">arr,var_name</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.length == <span class="number">1</span>)&#123;<span class="keyword">return</span> <span class="string">&#x27;function_var&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">if</span>(types.isVariableDeclaration(arr[<span class="number">0</span>]) &amp;&amp; arr[<span class="number">0</span>].declarations[<span class="number">0</span>].id.name == var_name)&#123;</span><br><span class="line">        <span class="keyword">if</span>(types.isNumericLiteral(arr[<span class="number">0</span>].declarations[<span class="number">0</span>].init) || types.isStringLiteral(arr[<span class="number">0</span>].declarations[<span class="number">0</span>].init));</span><br><span class="line">            <span class="keyword">return</span> arr[<span class="number">0</span>].declarations[<span class="number">0</span>].init.value;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span>(types.isExpressionStatement(arr[<span class="number">0</span>]) &amp;&amp; types.isAssignmentExpression(arr[<span class="number">0</span>].expression))&#123;</span><br><span class="line">        <span class="comment">//保证左节点的名字和之前传过来的相同</span></span><br><span class="line">        <span class="keyword">if</span>(arr[<span class="number">0</span>].expression.left.name == var_name)&#123;</span><br><span class="line">            <span class="comment">//如果是值就直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(types.isNumericLiteral(arr[<span class="number">0</span>].expression.right) || types.isStringLiteral(arr[<span class="number">0</span>].expression.right))&#123;</span><br><span class="line">                <span class="keyword">return</span> arr[<span class="number">0</span>].expression.right.value;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//如果有中间变量的情况,进入中间变量并进入下一层级</span></span><br><span class="line">            <span class="keyword">if</span>(types.isIdentifier(arr[<span class="number">0</span>].expression.right))&#123;</span><br><span class="line">                <span class="keyword">return</span> get_source_value(arr.slice(<span class="number">1</span>), arr[<span class="number">0</span>].expression.right.name);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//如果右边是判断表达式，先判断其判断表达式的argument的类型</span></span><br><span class="line">            <span class="keyword">if</span>(types.isUnaryExpression(arr[<span class="number">0</span>].expression.right))&#123;</span><br><span class="line">                <span class="keyword">if</span>(types.isIdentifier(arr[<span class="number">0</span>].expression.right.argument))&#123;</span><br><span class="line">                    <span class="keyword">let</span> ass_souce_var = get_source_value(arr.slice(<span class="number">1</span>), arr[<span class="number">0</span>].expression.right.name);</span><br><span class="line">                    <span class="keyword">if</span>(ass_souce_var==<span class="string">&#x27;function_var&#x27;</span>) <span class="keyword">return</span> ass_souce_var;</span><br><span class="line">                    <span class="keyword">return</span> !ass_souce_var;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">debugger</span>;</span><br><span class="line">                    <span class="keyword">if</span>(arr[<span class="number">0</span>].expression.right.operator == <span class="string">&#x27;void&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> !!<span class="built_in">eval</span>(generator(arr[<span class="number">0</span>].expression.right).code);</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(arr[<span class="number">0</span>].expression.right.operator == <span class="string">&#x27;!&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> !<span class="built_in">eval</span>(generator(arr[<span class="number">0</span>].expression.right).code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> get_source_value(arr.slice(<span class="number">1</span>), var_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;function_var&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取节点中test的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_test_result</span>(<span class="params">testNode,arr,init_value</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// console.log(&#x27;计算节点用到的stack内容&#x27;,generator(types.isBlockStatement(arr)).code,&#x27;-----&gt;&#x27;);</span></span><br><span class="line">    <span class="keyword">if</span>(types.isIdentifier(testNode) )&#123;</span><br><span class="line">        <span class="keyword">if</span>(init_value[testNode.name] || init_value[testNode.name]==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> init_value[testNode.name]</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> get_source_value(arr.reverse(),testNode.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//需要获得的是最底部的节点</span></span><br><span class="line"><span class="comment">//用于节点游走,为一个递归函数(大变量初始值,对应的SwitchStatement)</span></span><br><span class="line"><span class="comment">//base_var_name:for循环的变量,for循环的值,SwitchNode对应的node节点,init_data 初始化变量,init_var_indentify判断是否停止,SwitchObj游走到底部节点,out_arr用于保存参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_node_expression</span>(<span class="params">base_var_name,value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,for_start_value,stack</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(!init_var_identify(value)) <span class="keyword">return</span>;</span><br><span class="line">     <span class="keyword">let</span> init_value = init_data(value);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;开始进行变量初始化&#x27;</span>,init_value, init_var_identify(<span class="number">0</span>));</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;当前base_var_value&#x27;</span>,init_value[base_var_name],<span class="string">&#x27;end_value&#x27;</span>,for_start_value);</span><br><span class="line">     <span class="keyword">let</span> now_arr = get_lowest_node(init_value,SwitchNode,SwitchObj);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;当前参数&#x27;</span>,generator(types.blockStatement(stack)).code);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;当前节点参数&#x27;</span>,generator(types.blockStatement(now_arr)).code);</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> now_arr)&#123;</span><br><span class="line">         <span class="keyword">if</span>(types.isExpressionStatement(i) &amp;&amp; types.isAssignmentExpression(i.expression))&#123;</span><br><span class="line">             <span class="keyword">if</span>(i.expression.left.name == base_var_name)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(i.expression.operator == <span class="string">&#x27;=&#x27;</span>)&#123;</span><br><span class="line">                     get_node_expression(base_var_name,i.expression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,for_start_value,stack);</span><br><span class="line">                     <span class="keyword">continue</span>;</span><br><span class="line">                 &#125;;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(types.isBreakStatement(i)) <span class="keyword">continue</span>;</span><br><span class="line">         <span class="keyword">if</span>(!types.isIfStatement(i)) stack.push(i);</span><br><span class="line">         <span class="keyword">if</span>(types.isIfStatement(i))&#123;</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">&#x27;当前判断&#x27;</span>,generator(i.test).code);</span><br><span class="line">             <span class="keyword">let</span> consequentExpression = i.consequent.body[<span class="number">0</span>].expression;</span><br><span class="line">             <span class="keyword">let</span> alternateExpression = i.alternate.body[<span class="number">0</span>].expression;</span><br><span class="line">             <span class="keyword">let</span> if_left_arr = [],if_right_arr = [];</span><br><span class="line">             <span class="keyword">let</span> if_value = get_test_result(i.test,stack,init_value);</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">&#x27;if_value的值为&#x27;</span>,if_value);</span><br><span class="line">             <span class="keyword">let</span> now_stack = stack.slice(<span class="number">0</span>);</span><br><span class="line">             <span class="keyword">if</span>(types.isBinaryExpression(i.test))&#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;外部参数&#x27;,generator(types.blockStatement(out_arr)).code);</span></span><br><span class="line">                <span class="comment">// console.log(&#x27;当前if节点&#x27;,generator(i).code);</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;开始生成for循环&#x27;</span>);</span><br><span class="line">                <span class="keyword">let</span> for_begin_value = init_data(consequentExpression.right.value)[base_var_name];</span><br><span class="line">                <span class="keyword">if</span>(for_start_value == for_begin_value) <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">let</span> result_arr = [];</span><br><span class="line">                get_node_expression(base_var_name,for_begin_value,SwitchNode,init_data,init_var_identify,SwitchObj,result_arr,for_begin_value,[]);</span><br><span class="line">                out_arr.push(types.forStatement(<span class="literal">null</span>,i.test,<span class="literal">null</span>,types.blockStatement(result_arr)));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;生成for循环结束,开始进入else节点&#x27;</span>);</span><br><span class="line">                <span class="keyword">let</span> for_end_value = init_data(alternateExpression.right.value)[base_var_name];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;eles节点value&#x27;</span>,for_end_value);</span><br><span class="line">                <span class="keyword">let</span> else_result_arr = [];</span><br><span class="line">                get_node_expression(base_var_name,for_end_value,SwitchNode,init_data,init_var_identify,SwitchObj,else_result_arr,<span class="literal">null</span>,now_stack);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;else_result_arr&#x27;</span>,generator(types.blockStatement(else_result_arr).code));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">             &#125;<span class="keyword">else</span> <span class="keyword">if</span>(if_value==<span class="string">&#x27;function_var&#x27;</span>)&#123;</span><br><span class="line">                 <span class="comment">//这部分代表参数不可计算</span></span><br><span class="line">                 <span class="keyword">if</span>(types.isAssignmentExpression(consequentExpression) &amp;&amp; consequentExpression.left.name == base_var_name)&#123;</span><br><span class="line">                     get_node_expression(base_var_name,consequentExpression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,if_left_arr,for_start_value,now_stack);</span><br><span class="line">                 &#125;;</span><br><span class="line">                 <span class="keyword">if</span>(types.isAssignmentExpression(alternateExpression) &amp;&amp; alternateExpression.left.name == base_var_name)&#123;</span><br><span class="line">                     get_node_expression(base_var_name,alternateExpression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,if_right_arr,for_start_value,now_stack);</span><br><span class="line">                 &#125;;</span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//只有值需要判断的适合需要传递stack</span></span><br><span class="line">                 <span class="keyword">if</span>(!!if_value)&#123;</span><br><span class="line">                     get_node_expression(base_var_name,consequentExpression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,if_left_arr,for_start_value,now_stack);</span><br><span class="line">                 &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                     get_node_expression(base_var_name,alternateExpression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,if_right_arr,for_start_value,now_stack);</span><br><span class="line">                 &#125;;</span><br><span class="line">             &#125;;</span><br><span class="line">             out_arr.push(types.ifStatement(i.test,types.blockStatement(if_left_arr),types.blockStatement(if_right_arr)));</span><br><span class="line">             <span class="keyword">continue</span>;</span><br><span class="line">         &#125;;</span><br><span class="line">         <span class="keyword">if</span>(out_arr) out_arr.push(i);</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fix</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;init,test,update,body&#125; = path.node;</span><br><span class="line">    <span class="keyword">if</span>(update) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(!init) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> init_params_body = get_other_expression(body.body);</span><br><span class="line">    <span class="keyword">let</span> return_obj_statement = return_obj_create(init, init_params_body);</span><br><span class="line">    init_params_body.push(types.returnStatement(return_obj_statement));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将初始化的值eval进内存.后续可以直接调用</span></span><br><span class="line">    <span class="built_in">eval</span>(generator(types.functionDeclaration(types.identifier(<span class="string">&#x27;init_var_identify&#x27;</span>),</span><br><span class="line">        [init.declarations[<span class="number">0</span>].id],</span><br><span class="line">        types.blockStatement([types.returnStatement(test)])</span><br><span class="line">        )).code);</span><br><span class="line">    <span class="built_in">eval</span>(generator(types.functionDeclaration(types.identifier(<span class="string">&#x27;init_data&#x27;</span>),</span><br><span class="line">        [init.declarations[<span class="number">0</span>].id],</span><br><span class="line">        types.blockStatement(init_params_body)</span><br><span class="line">        )).code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> SwitchNode = get_switch_expression(body.body);</span><br><span class="line">    <span class="keyword">let</span> SwitchObj = get_switch_obj(SwitchNode);</span><br><span class="line">    <span class="keyword">let</span> out_arr = [],stack=[];</span><br><span class="line">    get_node_expression(init.declarations[<span class="number">0</span>].id.name,init.declarations[<span class="number">0</span>].init.value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,<span class="literal">null</span>,stack);</span><br><span class="line">    <span class="comment">// console.log(out_arr);</span></span><br><span class="line">    path.replaceWithMultiple(out_arr);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>已把上述还原，但是，有个致命的问题就是IF表达式判断。</strong></p>
<p><img src="/2022/03/13/ali/image-20220314224908224.png" alt="image-20220314224908224"></p>
<p>通过对这里的分析，发现其本质上是走的一个for循环的流程，同时，其对应的else节点属于结束节点。</p>
<p>大胆假设，假如test节点的类型为BinaryExpression，同时其right部分为MemberExpression，而且其Identifier部分为length，那么这个就为for循环的test部分，同时其第一次stack包含的var声明式，在这里为var E = 0;代表for循环的起始值，其中有个流程包含E++对应for循环的自增值。本质上这是一个环形结构。</p>
<h5 id="流程梳理"><a href="#流程梳理" class="headerlink" title="流程梳理"></a>流程梳理</h5><h6 id="STEP1-运行步骤"><a href="#STEP1-运行步骤" class="headerlink" title="STEP1 运行步骤"></a>STEP1 运行步骤</h6><p>初始化b=4</p>
<p>{ k: 4, o: 0, t: 0, b: 4 }</p>
<p>进入该节点</p>
<p><img src="/2022/03/13/ali/image-20220317210749234.png" alt="image-20220317210749234"></p>
<p>然后碰到if流，根据变量名判断，这属于函数参数名，所以这两个分支应该都会走到，进入第一个b=8的分支。</p>
<p><img src="/2022/03/13/ali/image-20220317210938365.png" alt="image-20220317210938365"></p>
<p>发现，接下来走到的是b=0的分支。</p>
<p>{ k: 0, o: 0, t: 0, b: 0 }</p>
<p><img src="/2022/03/13/ali/image-20220317211033300.png" alt="image-20220317211033300"></p>
<p>接着又进入了一个if分支，可以发现，这里是对A的长度进行了一个判断，进入b=64分支，</p>
<p>{ k: 0, o: 4, t: 4, b: 64 }</p>
<p><img src="/2022/03/13/ali/image-20220317211633194.png" alt="image-20220317211633194"></p>
<p>先走32这个分支，给x赋值</p>
<p><img src="/2022/03/13/ali/image-20220317222822658.png" alt="image-20220317222822658"></p>
<p>即接下来走的是b=3这个分支。</p>
<p>{ k: 3, o: 0, t: 0, b: 3 } </p>
<p><img src="/2022/03/13/ali/image-20220317211912799.png" alt="image-20220317211912799"></p>
<p>然后又跳转到128分支</p>
<p>{ k: 0, o: 8, t: 8, b: 128 }</p>
<p><img src="/2022/03/13/ali/image-20220317212010367.png" alt="image-20220317212010367"></p>
<p>然后又跳回0分支，也就是说，继续重复上述步骤。</p>
<p>那么我们需要梳理其流程，然后对其进行一个还原，在这里可以看到，我们在进入b=0分支后先进行了一个对其长度判断，然后</p>
<p>进入一长串循环该步骤，最后跳出到b=2这个分支。</p>
<p>其初始头为b=0结束头为b=128.</p>
<p>我们最后希望将其还原为</p>
<p>var E=0</p>
<p>for(;E&lt;A.length;){</p>
<p>​    ……</p>
<p>​     E++;</p>
<p>}</p>
<p>的形式，后面跟的是b=2的分支。</p>
<h5 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h5><p><img src="/2022/03/13/ali/image-20220329225917160.png" alt="image-20220329225917160"></p>
<p>也就是说，在if的判断表达式为二元表达式，类似a&lt;b这种形式的时候，都是生成的for循环，这样假如采取栈的形式当下一次的初值和开始的初值相等，那么就可以退出，但是，这是对于单情况而言，假如其中嵌套if表达式，那么还需对其进行一个判断。</p>
<p>思路：</p>
<ol>
<li>if表达式的判断部分为二元表达式，进入for循环，此处对应的是该流程的外部参数，记录if表达式中左节点的参数名(该处一般为接下来进行更新操作的地方)。</li>
<li>进行接下来的流程操作，假如直接是与for循环开始节点一样的值，那么直接返回，但是，假如是经过一个if表达式，其中，if表达式的判断部分为一开始的左节点参数，一般，这个参数初始值为0，即，随着for循环的运行，这个值会进入不同的流程，那么这部分的If表达式的节点都需要保留，那么，就只有在else节点结束后，才算退出for循环。</li>
</ol>
<p>if表达式逻辑值对比:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> ue 为<span class="keyword">for</span>循环生成的值</span><br><span class="line"> <span class="number">4581</span>流程</span><br><span class="line">ga = na === ue;  <span class="literal">true</span> </span><br><span class="line">  na = !ga;<span class="literal">false</span> </span><br><span class="line">  </span><br><span class="line">  <span class="number">6595</span>流程</span><br><span class="line">  na = ga === ue; <span class="literal">true</span> </span><br><span class="line">  ga = !na;<span class="literal">false</span> </span><br><span class="line">  </span><br><span class="line">  <span class="number">2.</span>根处为调用表达式</span><br><span class="line">   ga = ua[na];</span><br><span class="line">  na = !ga;<span class="literal">false</span> </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  ua = ga;表示存在，对应<span class="literal">true</span> </span><br><span class="line">  <span class="number">14465</span></span><br><span class="line">  da = sa;</span><br><span class="line">  sa = da;<span class="literal">true</span> </span><br><span class="line">  </span><br><span class="line">    da = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">  ua = ya;</span><br><span class="line">  na = e;</span><br><span class="line">  ga = na;</span><br><span class="line">  ue = !na; <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//这里Ie是生成的值，</span></span><br><span class="line">  ue = na === Ie;<span class="literal">false</span> </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  na = ga === ue,</span><br><span class="line">  ga = !na, <span class="literal">false</span> </span><br></pre></td></tr></table></figure>
<p>貌似有点规律</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">ast_tools解读</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> ast_tools源码解读</p>
<h4 id="IfWithExpressFix"><a href="#IfWithExpressFix" class="headerlink" title="IfWithExpressFix"></a>IfWithExpressFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311193502748.png" alt="image-20220311193502748"></p>
<p>主要是给不包含block的if表达式添加上，让其统一化。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a=<span class="number">1</span>) <span class="keyword">var</span> b=<span class="number">3</span>;</span><br><span class="line">-----------------</span><br><span class="line"><span class="keyword">if</span>(a=<span class="number">1</span>)&#123;<span class="keyword">var</span> b=<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ForWithExpressFix-amp-ForWithForFix"><a href="#ForWithExpressFix-amp-ForWithForFix" class="headerlink" title="ForWithExpressFix &amp; ForWithForFix"></a>ForWithExpressFix &amp; ForWithForFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311193754270.png" alt="image-20220311193754270"></p>
<p>都是给For循环规范化。</p>
<h4 id="ReturnSeqFix"><a href="#ReturnSeqFix" class="headerlink" title="ReturnSeqFix"></a>ReturnSeqFix</h4><p>将return中包含逗号表达式的还原</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311194547853.png" alt="image-20220311194547853"></p>
<p>第一部分用于将所有的逗号表达式添加到数组中，第二步主要是将逗号表达式前n-1项加到return前面，然后将return节点只包含逗号表达式的最后一项。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;<span class="keyword">return</span> c=a+<span class="number">1</span>,b&#125;</span><br><span class="line">--------------------------</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;c=a+<span class="number">1</span>;<span class="keyword">return</span> ab&#125;</span><br></pre></td></tr></table></figure>
<h4 id="VariableDeclaratorFix"><a href="#VariableDeclaratorFix" class="headerlink" title="VariableDeclaratorFix"></a>VariableDeclaratorFix</h4><p>声明表达式及赋值表达式还原。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a,b,c;</span><br><span class="line">m=<span class="number">2</span>,d=<span class="number">3</span>,n=<span class="number">4</span>;</span><br><span class="line">-----------</span><br><span class="line"><span class="keyword">var</span> a;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"><span class="keyword">var</span> c;</span><br><span class="line">m=<span class="number">2</span>;</span><br><span class="line">d=<span class="number">3</span>;</span><br><span class="line">n=<span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ConditionalFix"><a href="#ConditionalFix" class="headerlink" title="ConditionalFix"></a>ConditionalFix</h4><p>三目表达式转化为if-else的形式。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200057628.png" alt="image-20220311200057628"></p>
<h4 id="SequenceExpressionFix"><a href="#SequenceExpressionFix" class="headerlink" title="SequenceExpressionFix"></a>SequenceExpressionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200313589.png" alt="image-20220311200313589"></p>
<p>本质上还是逗号表达式的还原。</p>
<h4 id="AssignmentWithConditionalFix"><a href="#AssignmentWithConditionalFix" class="headerlink" title="AssignmentWithConditionalFix"></a>AssignmentWithConditionalFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200459670.png" alt="image-20220311200459670"></p>
<p>还是对三目表达的还原，这里限制了其consequent和alternate部分都为数字。</p>
<h4 id="LogicalExpressionFix"><a href="#LogicalExpressionFix" class="headerlink" title="LogicalExpressionFix"></a>LogicalExpressionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200832831.png" alt="image-20220311200832831"></p>
<p>将逻辑表达式转化为条件表达式。</p>
<h4 id="UnaryFunctionFix"><a href="#UnaryFunctionFix" class="headerlink" title="UnaryFunctionFix"></a>UnaryFunctionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311201334471.png" alt="image-20220311201334471"></p>
<p>把自执行函数的壳去掉。</p>
<h4 id="ControlFlowFix"><a href="#ControlFlowFix" class="headerlink" title="ControlFlowFix"></a>ControlFlowFix</h4><p>控制流平坦化。</p>
<ul>
<li><p>进入大FOR循环，获取第一个初始化Ci的表达式，然后根据一个三目获取变量的名称(其余的条件貌似不是针对大控制流的)。</p>
</li>
<li><p>定义了两个数组，分别用于存取大控制流的变量</p>
</li>
</ul>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311203909800.png" alt="image-20220311203909800"></p>
<ul>
<li><p>生成了一个函数，给定一个初始的li然后会返回一个字典包含这五个参数。</p>
</li>
<li><p>进入控制流，然后生产了一个用于判断是否结束的函数。</p>
</li>
<li><p>获取主流程switch节点</p>
</li>
<li>初始化了get_control_struct函数，steps_hash_list，bodys，get_next_control_param函数，</li>
<li>定义了一个get_node函数(控制流的另一种形式，初始li参数)</li>
</ul>
<blockquote>
<p>控制流的另一种形式：将上述控制流转化为一个类似字典的东西，键指代控制流指向，值包含其内容为node类型。</p>
</blockquote>
<h5 id="get-code函数"><a href="#get-code函数" class="headerlink" title="get_code函数"></a>get_code函数</h5><p>控制流的整体流程</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311210310953.png" alt="image-20220311210310953"></p>
<p>这里获取所有初始参数的值</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311210631798.png" alt="image-20220311210631798"></p>
<p>这一步应该是不断计算，获取最下层节点即Ai节点的值。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311211105814.png" alt="image-20220311211105814"></p>
<p>在这里，由于包含IF的模块，所以还要对其进行一个判断，get_next_control_param用于获取其类型是否包含这种IF。</p>
<p>向栈中添加这两个节点值。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311211853434.png" alt="image-20220311211853434"></p>
<p>然后根据这个11490在进行一个这个流程，在进入while流程中，基本上就将控制流还原了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ba = <span class="built_in">window</span>;</span><br><span class="line">Nt = r;</span><br><span class="line">ur = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">Jo = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">ei = O;</span><br><span class="line"><span class="keyword">if</span> (Nt) &#123;</span><br><span class="line">。。。。</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>整体思想，获取初始参数的值，计算出中间参数的值，找到最底层的节点，获取当前节点的表达式，然后获取下一步初始参数的值(要对for循环中的条件进行一个判断)，反复调用并合并节点，最后将整个大FOR循环脱掉。</p>
</blockquote>
<h4 id="ConstantFix"><a href="#ConstantFix" class="headerlink" title="ConstantFix"></a>ConstantFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311220545744.png" alt="image-20220311220445933"></p>
<p>字符串的还原。</p>
<h4 id="DecryptVariableFix"><a href="#DecryptVariableFix" class="headerlink" title="DecryptVariableFix"></a>DecryptVariableFix</h4><p>将w.pop()的形式，还原为字符串。</p>
<h4 id="ReserveStrFix"><a href="#ReserveStrFix" class="headerlink" title="ReserveStrFix"></a>ReserveStrFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311215701659.png" alt="image-20220311215701659"></p>
<p>这玩意的还原。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/07/rs4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/07/rs4/" class="post-title-link" itemprop="url">rs4</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="RS4"><a href="#RS4" class="headerlink" title="RS4"></a>RS4</h4><p>进入其代码中，可以发现，充斥着大量的IF-ELSE流，干扰分析，让人头痛。</p>
<p><img src="/2022/03/07/rs4/image-20220307225925441.png" alt="image-20220307225925441"></p>
<p>通过观察发现，这里面虽然充斥大量的IF-ELSE流，但是跟进去就会发现，它每一个区域块都对应了其IF提到的值-1，最后的那个_$yZ(767,3)其实对应的是255这个值的流程。</p>
<p><img src="/2022/03/07/rs4/image-20220307230312062.png" alt="image-20220307230312062"></p>
<p>用Babel解析IFstatement，会得到三部分：</p>
<ul>
<li>test: 上述 _$pp &lt; 255的验证部分</li>
<li>consequent: BlockStatement 对应 后面的{}区域</li>
<li>alternate:else后跟的{}区域</li>
</ul>
<p>编写如下插件，将其转化为Switch-case的形式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIfnode</span>(<span class="params">testNode,consequentNode, alternateNode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> currentvalue = testNode.right.value;</span><br><span class="line">    <span class="keyword">if</span>(types.isIfStatement(consequentNode.body[<span class="number">0</span>]) &amp;&amp; types.isBinaryExpression(consequentNode.body[<span class="number">0</span>].test))&#123;</span><br><span class="line">        getIfnode(consequentNode.body[<span class="number">0</span>].test,consequentNode.body[<span class="number">0</span>].consequent, consequentNode.body[<span class="number">0</span>].alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isBlockStatement(alternateNode) &amp;&amp; types.isIfStatement(alternateNode.body[<span class="number">0</span>]) &amp;&amp; types.isBinaryExpression(alternateNode.body[<span class="number">0</span>].test))&#123;</span><br><span class="line">        getIfnode(alternateNode.body[<span class="number">0</span>].test,alternateNode.body[<span class="number">0</span>].consequent, alternateNode.body[<span class="number">0</span>].alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isIfStatement(alternateNode))&#123;</span><br><span class="line">        getIfnode(alternateNode.test,alternateNode.consequent, alternateNode.alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(!types.isIfStatement(consequentNode.body[<span class="number">0</span>]))&#123;</span><br><span class="line">        fullNode[currentvalue-<span class="number">1</span>] = consequentNode.body[<span class="number">0</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isBlockStatement(alternateNode) &amp;&amp; !types.isIfStatement(alternateNode.body[<span class="number">0</span>]))&#123;</span><br><span class="line">        fullNode[currentvalue] = alternateNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> all_func_list = [<span class="string">&#x27;_$pp&#x27;</span>, <span class="string">&#x27;_$XF&#x27;</span>, <span class="string">&#x27;_$by&#x27;</span>, <span class="string">&#x27;_$Wi&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> fullNode = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> If2Switch = &#123;</span><br><span class="line">    <span class="function"><span class="title">IfStatement</span>(<span class="params">path</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;test, consequent, alternate&#125; = path.node;</span><br><span class="line">        <span class="keyword">if</span> (!types.isBinaryExpression(test) || !types.isIdentifier(test.left) || test.operator !== <span class="string">&#x27;&lt;&#x27;</span> || !types.isNumericLiteral(test.right)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">let</span> Ifun_name = test.left.name;</span><br><span class="line">        <span class="keyword">if</span>(all_func_list.indexOf(Ifun_name) == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        getIfnode(test, consequent, alternate);</span><br><span class="line">        <span class="keyword">let</span> swichcasearr = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> fullNode)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fullNode[i] !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(types.isBlockStatement(fullNode[i]))&#123;</span><br><span class="line">                     swichcasearr.push(types.switchCase(types.valueToNode(i), fullNode[i].body));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    swichcasearr.push(types.switchCase(types.valueToNode(i), [fullNode[i]]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                swichcasearr.push(types.switchCase(types.valueToNode(i), []));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        path.replaceWith(types.switchStatement(types.identifier(Ifun_name), swichcasearr));</span><br><span class="line">        fullNode = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过进一步观察，发现代码中_$lE反复出现，且其调用为字面量，</p>
<p><img src="/2022/03/07/rs4/image-20220308202132866.png" alt="image-20220308202132866"></p>
<p><img src="/2022/03/07/rs4/image-20220308202141280.png" alt="image-20220308202141280"></p>
<p>因此，该参数可以作为一个还原参数，接下来就是去寻找这个参数在哪生成，</p>
<p><img src="/2022/03/07/rs4/image-20220308202244145.png" alt="image-20220308202244145"></p>
<p>除了初始化部分，该参数只在这里出现，我们发现在上述数组初始化的时候，初始化了_$Ei，然后$Ei又在下面进行了修改啥的，先把这部分抠出来作为环境。</p>
<p>然后把这个数组以及另一个解密函数对其还原，发现基本上能看了，但是在这串代码中，</p>
<p><img src="/2022/03/07/rs4/image-20220308205506033.png" alt="image-20220308205506033"></p>
<p>红框标注的代码应该是之前生成的，所以，要针对其进行还原的话，还得把这里给东西抠出来。</p>
<h5 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h5><p>首先重新进入网站，打上script断点，发现定义了scj，和一个长数组</p>
<p><img src="/2022/03/07/rs4/image-20220308220816827.png" alt="image-20220308220816827"></p>
<p>跟下去会进入一段页面自带的js，跳过去发现scj还是没有生成，但是却多了一些字符和函数啥的，同时上一步提到的aebi已经生成了。    </p>
<p><img src="/2022/03/07/rs4/image-20220308221247264.png" alt="image-20220308221247264"></p>
<p>也就是说，在这一步，应该会生成许多东西，接下来，将这个js扣下来对其进行还原。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/" class="post-title-link" itemprop="url">知乎vmp</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>449</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="知乎"><a href="#知乎" class="headerlink" title="知乎"></a>知乎</h4><p>加密参数：x-zse-96</p>
<p>插桩位置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;索引：&quot;</span>, <span class="built_in">this</span>.C, <span class="string">&quot; 值：&quot;</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">key, value</span>) </span>&#123;<span class="keyword">if</span> (value == <span class="built_in">window</span>) &#123;<span class="keyword">return</span> <span class="literal">undefined</span>&#125; <span class="keyword">return</span> value&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/image-20220306141125895.png" alt="image-20220306141125895"></p>
<p><strong>大字符串</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlist = <span class="string">&quot;RuPtXwxpThIZ0qyz_9fYLCOV8B1mMGKs7UnFHgN3iDaWAJE-Qrk2ecSo6bjd4vl5&quot;</span></span><br></pre></td></tr></table></figure>
<p>这里面的参数都是由这个大字符串通过索引的方式生成的。</p>
<p>据说生成的签名参数为4个一组。</p>
<p>该处生成的签名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;a_F8Fguqc0Yxo0NqzBOykiUBSLYfnGF8z9Y8SAeqQ0xp&#x27;</span></span><br></pre></td></tr></table></figure>
<p>个人认为，要分析如上内容，首先要知道，它是靠什么生成的数，其次是要知道，在生成第一次数了，后面的流程是什么，紧接着是要知道哪些流程是采取的固定的计算方法，这样就可以把其算法复现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/06/redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/06/redis/" class="post-title-link" itemprop="url">redis</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/04/HMM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/04/HMM/" class="post-title-link" itemprop="url">HMM</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="MM"><a href="#MM" class="headerlink" title="MM"></a>MM</h4><h6 id="markov-model："><a href="#markov-model：" class="headerlink" title="markov model："></a>markov model：</h6><p>马尔可夫模型，指的是在给定当前知识的情况下，过去对于预测未来是无关的，诶个状态的转移，只依赖之前的n个状态，被称为是一个n阶模型。</p>
<p><img src="/2022/03/04/HMM/image-20220305130113281.png" alt="image-20220305130113281"></p>
<h6 id="转移矩阵："><a href="#转移矩阵：" class="headerlink" title="转移矩阵："></a>转移矩阵：</h6><p>指的是从一个状态转移到另一个状态的概率，整体上为一个n*n的矩阵</p>
<h4 id="HMM"><a href="#HMM" class="headerlink" title="HMM"></a>HMM</h4><p>用来描述 含有隐含未知参数的马尔可夫过程。对于投色子来讲，假如有三种色子，分别包含6 8 10个面，那么每个色子表现出1的概率是不同的，同时，我们还知道色子丢出来的结果到底是几，那么我们就可以用这个结果去反推出对应的值是由哪个色子投出来的。</p>
<h6 id="HIDDEN-STATE"><a href="#HIDDEN-STATE" class="headerlink" title="HIDDEN STATE:"></a>HIDDEN STATE:</h6><p>隐藏状态集合</p>
<h6 id="Observations-state"><a href="#Observations-state" class="headerlink" title="Observations state:"></a>Observations state:</h6><p>观测状态集合</p>
<h6 id="Start-Probability"><a href="#Start-Probability" class="headerlink" title="Start Probability:"></a>Start Probability:</h6><p>隐藏状态初始化的概率值</p>
<h6 id="Hidden-Transition-Probability"><a href="#Hidden-Transition-Probability" class="headerlink" title="Hidden Transition_Probability:"></a>Hidden Transition_Probability:</h6><p>隐藏状态概率转移矩阵</p>
<h6 id="Hidden-to-Observations-Probability"><a href="#Hidden-to-Observations-Probability" class="headerlink" title="Hidden to Observations Probability:"></a>Hidden to Observations Probability:</h6><p>隐藏状态到观测状态概率集合</p>
<h5 id="Viterb算法"><a href="#Viterb算法" class="headerlink" title="Viterb算法"></a>Viterb算法</h5><p>本质上是动态规划，假设初始状态有n种，观测序列的长度为m，那么总共的路径数就为m的n次方，要想从中找到最优路径往往是不显示的，但是，对于一段长度为x路径来说，要是该路径是最优的，那么其长度为x-1的子路径也一定是最优的，那么问题就变为了，根据每一条路径，在其基础上，找到其距下个节点的最优路径即可，这样问题就缩小为了m*n个，极大降低了复杂度。</p>
<h6 id="DEMO-以一个看病为例"><a href="#DEMO-以一个看病为例" class="headerlink" title="DEMO(以一个看病为例)"></a>DEMO(以一个看病为例)</h6><p>首先定义了隐藏状态：健康、生病</p>
<p>观测序列：正常，冷，发烧(这里指代我们看到的情况)</p>
<p>初始概率：健康：0.6 生病：0.4</p>
<p>隐藏状态概率转移矩阵:健康到健康0.7 健康到生病0.3 生病到健康0.4 生病到生病0.6’</p>
<p>隐藏状态到观测状态概率集合:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Healthy&quot;</span>: &#123;<span class="attr">&quot;normal&quot;</span>: <span class="number">0.5</span>, <span class="attr">&quot;cold&quot;</span>: <span class="number">0.4</span>, <span class="attr">&quot;dizzy&quot;</span>: <span class="number">0.1</span>&#125;,</span><br><span class="line"> <span class="string">&quot;Fever&quot;</span>: &#123;<span class="attr">&quot;normal&quot;</span>: <span class="number">0.1</span>, <span class="attr">&quot;cold&quot;</span>: <span class="number">0.3</span>, <span class="attr">&quot;dizzy&quot;</span>: <span class="number">0.6</span>&#125;,</span><br></pre></td></tr></table></figure>
<p>我们要根据观测序列推断出其真实情况，在这里每一条路径都是由上一时刻的状态X隐藏状态转移概率矩阵X隐藏状态到观测状态概率集合(这里要针对每一个隐藏状态，因为需要对这个隐藏状态进行解码).</p>
<p><img src="/2022/03/04/HMM/image-20220305170041105.png" alt="image-20220305170041105"></p>
<p>python 实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Hidden_states = (<span class="string">&quot;Healthy&quot;</span>, <span class="string">&quot;Fever&quot;</span>)  <span class="comment"># 隐状态集合</span></span><br><span class="line"></span><br><span class="line">Observations_states = (<span class="string">&quot;normal&quot;</span>, <span class="string">&quot;cold&quot;</span>, <span class="string">&quot;dizzy&quot;</span>)  <span class="comment"># 观测状态集合</span></span><br><span class="line"></span><br><span class="line">Start_probability = &#123;</span><br><span class="line">    <span class="string">&quot;Healthy&quot;</span>: <span class="number">0.6</span>,</span><br><span class="line">    <span class="string">&quot;Fever&quot;</span>: <span class="number">0.4</span>,</span><br><span class="line">&#125;  <span class="comment"># 表示病人第一次到访时医生认为其所处的HMM状态，他唯一知道的是病人倾向于是健康的（可以理解为这是基于一个对大众身体信息的了解得出的初始状态）</span></span><br><span class="line"><span class="number">2</span>*<span class="number">2</span></span><br><span class="line">Hidden_transition_probability = &#123;  <span class="comment"># 隐马尔可夫链中身体状态的状态转移概率，我们能够看到，当天健康的人，第二天有30%的概率会发烧</span></span><br><span class="line">    <span class="string">&quot;Healthy&quot;</span>: &#123;<span class="string">&quot;Healthy&quot;</span>: <span class="number">0.7</span>, <span class="string">&quot;Fever&quot;</span>: <span class="number">0.3</span>&#125;,</span><br><span class="line">    <span class="string">&quot;Fever&quot;</span>: &#123;<span class="string">&quot;Healthy&quot;</span>: <span class="number">0.4</span>, <span class="string">&quot;Fever&quot;</span>: <span class="number">0.6</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">3</span></span><br><span class="line">Hidden_observations_probability = (</span><br><span class="line">    &#123;  <span class="comment"># 原来叫emission_probability。这里表示病人每天的感觉的可能性。即，如果他是一个健康人，有50%的可能会感觉正常，40%觉得冷，10%觉得头晕</span></span><br><span class="line">        <span class="string">&quot;Healthy&quot;</span>: &#123;<span class="string">&quot;normal&quot;</span>: <span class="number">0.5</span>, <span class="string">&quot;cold&quot;</span>: <span class="number">0.4</span>, <span class="string">&quot;dizzy&quot;</span>: <span class="number">0.1</span>&#125;,</span><br><span class="line">        <span class="string">&quot;Fever&quot;</span>: &#123;<span class="string">&quot;normal&quot;</span>: <span class="number">0.1</span>, <span class="string">&quot;cold&quot;</span>: <span class="number">0.3</span>, <span class="string">&quot;dizzy&quot;</span>: <span class="number">0.6</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">viterbi</span>(<span class="params">obs, states, start_p, trans_p, h2o_p</span>):</span> <span class="comment"># Viterbi算法</span></span><br><span class="line">    V = [&#123;&#125;]</span><br><span class="line">    path = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize base cases (t == 0)</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> states:</span><br><span class="line">        V[<span class="number">0</span>][y] = start_p[y] * h2o_p[y][obs[<span class="number">0</span>]] </span><br><span class="line">        <span class="comment"># 初始状态，由start的概率，对应乘上发射概率，即由隐状态到观测状态的可能性</span></span><br><span class="line">        path[y] = [y] <span class="comment"># 记录下相应的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run Viterbi for t &gt; 0，每天都要更新计算一遍</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(obs)):</span><br><span class="line">        V.append(&#123;&#125;)</span><br><span class="line">        newpath = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> states:</span><br><span class="line">            <span class="comment"># 对于每个状态，计算其由前一天的各个状态，到达今天的y的概率大小，与y0自身相比较，取最大值</span></span><br><span class="line">            <span class="comment"># 前一天到达今天的每个状态对应的路径大小都计算了，取最大值。作为V[t][y]的值，并更新路径</span></span><br><span class="line">            <span class="comment"># print(&#x27;V[t-1]:&#x27;,V[t-1],&#x27;trans_p:&#x27;,trans_p,&#x27;h2o_p[y]:&#x27;,h2o_p[y],[V[t-1][y0] * trans_p[y0][y] * h2o_p[y][obs[t]] for y0 in states])</span></span><br><span class="line">            (prob, state) = <span class="built_in">max</span>([(V[t-<span class="number">1</span>][y0] * trans_p[y0][y] * h2o_p[y][obs[t]], y0) <span class="keyword">for</span> y0 <span class="keyword">in</span> states])</span><br><span class="line">            <span class="built_in">print</span>(V[t],y)</span><br><span class="line">            V[t][y] = prob</span><br><span class="line">            newpath[y] = path[state] + [y]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Don&#x27;t need to remember the old paths</span></span><br><span class="line">        path = newpath</span><br><span class="line">        <span class="comment"># print(path)</span></span><br><span class="line">    <span class="comment"># print_dptable(V)</span></span><br><span class="line">    <span class="comment"># 最后一天</span></span><br><span class="line">    (prob, state) = <span class="built_in">max</span>([(V[<span class="built_in">len</span>(obs) - <span class="number">1</span>][y], y) <span class="keyword">for</span> y <span class="keyword">in</span> states])</span><br><span class="line">    <span class="keyword">return</span> (prob, path[state])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example</span>():</span></span><br><span class="line">    <span class="keyword">return</span> viterbi(Observations_states,</span><br><span class="line">                   Hidden_states,</span><br><span class="line">                   Start_probability,</span><br><span class="line">                   Hidden_transition_probability,</span><br><span class="line">                   Hidden_observations_probability)</span><br><span class="line"><span class="built_in">print</span>(example())    </span><br></pre></td></tr></table></figure>
<h5 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h5><p>已知：</p>
<ul>
<li>观测序列(指历年主题比重)</li>
<li>状态转移矩阵:共现词矩阵(需要进行一个归一化)</li>
</ul>
<p>目的:使用Baum-Welch算法，根据12-21年的比重，预测22-25年的比重</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/02/27/%E5%85%B3%E8%81%94%E6%8C%96%E6%8E%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/27/%E5%85%B3%E8%81%94%E6%8C%96%E6%8E%98/" class="post-title-link" itemprop="url">关联挖掘</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>709</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="关联挖掘"><a href="#关联挖掘" class="headerlink" title="关联挖掘"></a>关联挖掘</h4><h5 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h5><p>频繁项集：n项的集合。</p>
<p>支持度：代表A、B同时出现的概率，如果概率小，那么说明A与B的关系不大，如果A、B总是同时出现，那么说明他们是相关的。</p>
<script type="math/tex; mode=display">
support = P(AUB)</script><p>置信度：包含A的数据集中包含B的百分比。</p>
<h5 id="Apriori算法"><a href="#Apriori算法" class="headerlink" title="Apriori算法"></a>Apriori算法</h5><p>使用候选项集找频繁项集</p>
<p>核心思想，只要一个项集是非频繁的，那么包含他的项集就都是非频繁的。</p>
<h5 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h5><p>关联矩阵转布尔矩阵</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data = final_data.copy()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">map_func</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data.columns:</span><br><span class="line">    data[i] = data[i].<span class="built_in">map</span>(<span class="keyword">lambda</span> x:map_func(x))</span><br></pre></td></tr></table></figure>
<p>计算关联规则</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mlxtend.preprocessing <span class="keyword">import</span> TransactionEncoder</span><br><span class="line"><span class="keyword">from</span> mlxtend.frequent_patterns <span class="keyword">import</span> apriori</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用 Apriori 找出频繁项集</span></span><br><span class="line">freq = apriori(data, min_support=<span class="number">0.1</span>, use_colnames=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#导入关联规则包</span></span><br><span class="line"><span class="keyword">from</span> mlxtend.frequent_patterns <span class="keyword">import</span> association_rules</span><br><span class="line"><span class="comment">#计算关联规则</span></span><br><span class="line">result = association_rules(freq, metric=<span class="string">&quot;confidence&quot;</span>, min_threshold=<span class="number">0.8</span>)</span><br></pre></td></tr></table></figure>
<p>这里采用最小支持度为0.1，最小置信度为0.8</p>
<p><img src="/2022/02/27/%E5%85%B3%E8%81%94%E6%8C%96%E6%8E%98/image-20220227175750485.png" alt="image-20220227175750485"></p>
<p>会得到如下51项关联规则，其中support代表支持度,confidence代表提升度。</p>
<p>画图：</p>
<p><img src="/2022/02/27/%E5%85%B3%E8%81%94%E6%8C%96%E6%8E%98/image-20220227175825809.png" alt="image-20220227175825809"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/02/26/TF-IDF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/26/TF-IDF/" class="post-title-link" itemprop="url">TF-IDF</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介:"></a>算法简介:</h4><h5 id="TF"><a href="#TF" class="headerlink" title="TF:"></a>TF:</h5><p> TF算法，全称Term frequency，翻译过来就是词频，顾名思义，就是词的频率：</p>
<script type="math/tex; mode=display">
某词语的词频 = \frac{该词语在一篇文章所出现的次数}{该篇文章包含的词语数}</script><p>通常来讲，我们认为一个词出现的次数越多，那么该词语就越重要，但是，由于语言的特性，文章中包含许许多多停用词，虚词等无实际意义的词语，那么我们在对中文文本进行处理的时候，首先要对其进行一个预处理操作，去掉文章中的停用词等，以消除无实际意义的词产生的影响。</p>
<p>但是，由于一词多意及同义词的现象，单纯的词频统计往往在计算关键词的时候，出现一定的偏差，导致所得结果与实际情况差别较大。</p>
<blockquote>
<p>词频指代的是一篇文章</p>
</blockquote>
<h5 id="IDF"><a href="#IDF" class="headerlink" title="IDF:"></a>IDF:</h5><p>IDF算法，全称Inverse Document Frequency，意译过来就是逆文档频率。</p>
<p><strong>核心思想:</strong></p>
<p>一个词语在文档中出现的次数越少，那么逆文档频率越大，即区分类别的能力越强，可以认为是关键词。</p>
<p><strong>逆文档解释(个人理解)：</strong></p>
<p>​        记总共有m个文档，有n个文档中包含了某一个词语，那么对于该词语的文档出现概率为：</p>
<script type="math/tex; mode=display">
某词语的文档频率 = \frac{出现该词语的n篇文档}{m篇文档}</script><p>假设一个词只在100篇文档中出现，但是由于文档数量过大(例如10000)，那么该词语的文档频率就会非常的小(1%)，和0基本上没任何区别，也就是说，这个词和没出现的词没明显的差异，并不能做到对文档有很好的区分作用。</p>
<p>在此基础上，若我们取文档频率的倒数(这里称为逆频率)，那么上述提到的值就为100，这样一来，就可以很好的消除未出现词的影响，以及对关键词有一个很好的区分作用。</p>
<p>但是，这样一来还是有问题，直接取倒数的话，得到的数据过于离散，在上述例子中，逆频率最少(词只出现一次为10000)与最多(词篇篇都出现1)的量级就会过大，在数学上，常用对数的方法，以消除量级过大的影响。</p>
<p>因此最终逆文档的公式：</p>
<script type="math/tex; mode=display">
某词语逆文档频率 = \frac{m篇文档}{出现该词语的文档数+1}</script><blockquote>
<p>补充:这里+1的主要目的是为了消除未出现的词的影响(使逆文档频率无穷大).</p>
</blockquote>
<h5 id="TF-IDF"><a href="#TF-IDF" class="headerlink" title="TF-IDF"></a>TF-IDF</h5><p>词频-逆文档频率，本质上就是TF和IDF的乘积，TF的本质是要获取当前文章的高频词语，而IDF是计算该词语在文档集合中的重要程度，对于一个词，只在一篇文章中出现多次，那么该词就会有很高的TF以及IDF，那么我们就认为这个词就是关键词.</p>
<blockquote>
<p>TF-IDF本质上是综合了TF和IDF的特性，对关键词加以区分的算法.</p>
</blockquote>
<h4 id="简单案例"><a href="#简单案例" class="headerlink" title="简单案例"></a>简单案例</h4><p>这里采用Python的Sklearn包为例(取自网上Demo).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导入特征提取包,第一个用于计数,第二个用于计算词频</span></span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfTransformer</span><br><span class="line"> </span><br><span class="line">x_train = [<span class="string">&#x27;TF-IDF 主要 思想 是&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;算法 一个 重要 特点 可以 脱离 语料库 背景&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;如果 一个 网页 被 很多 其他 网页 链接 说明 网页 重要&#x27;</span>]</span><br><span class="line">x_test=[<span class="string">&#x27;原始 文本 进行 标记&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;主要 思想&#x27;</span>]</span><br><span class="line"> </span><br><span class="line"><span class="comment">#该类会将文本中的词语转换为词频矩阵，矩阵元素a[i][j] 表示j词在i类文本下的词频</span></span><br><span class="line">vectorizer = CountVectorizer(max_features=<span class="number">10</span>)</span><br><span class="line"><span class="comment">#该类会统计每个词语的tf-idf权值</span></span><br><span class="line">tf_idf_transformer = TfidfTransformer()</span><br><span class="line"><span class="comment">#将文本转为词频矩阵并计算tf-idf</span></span><br><span class="line">tf_idf = tf_idf_transformer.fit_transform(vectorizer.fit_transform(x_train))</span><br><span class="line"><span class="comment">#将tf-idf矩阵抽取出来，元素a[i][j]表示j词在i类文本中的tf-idf权重</span></span><br><span class="line">x_train_weight = tf_idf.toarray()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#对测试集进行tf-idf权重计算</span></span><br><span class="line">tf_idf = tf_idf_transformer.transform(vectorizer.transform(x_test))</span><br><span class="line">x_test_weight = tf_idf.toarray()  <span class="comment"># 测试集TF-IDF权重矩阵</span></span><br><span class="line"><span class="comment"># 获取关键词集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_keywords</span>(<span class="params">matrixArray, keywordsArray</span>):</span></span><br><span class="line">    <span class="keyword">return</span> [keywordsArray[index] <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(matrixArray)) <span class="keyword">if</span> matrixArray[index]&gt;<span class="number">0</span>] </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;输出x_train文本向量：&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(x_train_weight)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;输出x_test文本向量：&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(x_test_weight)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x_test_weight)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;测试集第<span class="subst">&#123;i&#125;</span>个文本的关键词是&#x27;</span>,get_keywords(x_test_weight[i], vectorizer.get_feature_names_out()))</span><br></pre></td></tr></table></figure>
<p>这里x_train代表我们采用了三个文本，x_test用于测试.</p>
<ol>
<li>首先我们载入包和训练集和测试集</li>
<li>接着采用计数类,将词语转化为词频矩阵.然后初始化一个用于计算tf-idf的类</li>
<li>将训练集导入其中进行训练.最后输出测试集中的关键词.</li>
</ol>
<p><img src="/2022/02/26/TF-IDF/image-20220226224241971.png" alt="image-20220226224241971"></p>
<h4 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h4><h5 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景:"></a>项目背景:</h5><p>采集<a target="_blank" rel="noopener" href="http://www.safehoo.com/Case/Case/Collapse网站的数据，收集每段事故的标题，事故概况，事故原因，采取TFIDF算法计算出关键词">http://www.safehoo.com/Case/Case/Collapse网站的数据，收集每段事故的标题，事故概况，事故原因，采取TFIDF算法计算出关键词</a>.</p>
<h5 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h5><h6 id="网址分析"><a href="#网址分析" class="headerlink" title="网址分析:"></a>网址分析:</h6><p>首先进入网址发现总共包含668条数据要采集，每页包含30条数据，通过翻页发现，该网站是由页码来控制网站展示的内容,在这里<a target="_blank" rel="noopener" href="http://www.safehoo.com/Case/Case/Collapse/List_23.shtml">坍塌事故-案例分析-安全管理网 (safehoo.com)</a>表示的是携带最新数据的页码,其网址中包含的页码为23,进一步分析,发现其尾页的页码为1.同时,页面是通过a标签的href链接进行跳转到事故的详情页的,在详情页中数据都是保存在类名为c_content_text的div标签中.针对如上网站,设计如下爬取思路:</p>
<ol>
<li>对携带页面的页面进行请求,解析网页,获取指向详情页的链接,将其保存在EXCEL中</li>
<li>对第一步爬取的详情页链接发起请求,对网页进行解析,将解析的结果以EXCEL保存.</li>
</ol>
<h6 id="爬虫程序撰写"><a href="#爬虫程序撰写" class="headerlink" title="爬虫程序撰写"></a>爬虫程序撰写</h6><p>这里使用Python撰写爬虫.</p>
<p>模块介绍:requests+re+etree+pandas+tqdm</p>
<ul>
<li><strong>requests:</strong> 爬虫模块,主要用于向网站发起请求,获取网址的HTML文本</li>
<li><strong>re:</strong>正则表达式模块,用于文本进行处理等操作</li>
<li><strong>etree:</strong>将HTML文本转化为解析树的形式,以用于对网页的解析</li>
<li><strong>pandas:</strong>数据处理模块,可将数据存入EXCEL</li>
<li><strong>tqdm</strong>:进度条</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 详情页爬取</span></span><br><span class="line"><span class="comment"># requests 爬取网页</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># 解析网页 </span></span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="comment"># 正则表达式</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># 将dataframe(数据框) 导出成excel</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># 将代码执行过程以进度条展示</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line">tempdict = &#123;</span><br><span class="line"><span class="comment">#     存储的标题</span></span><br><span class="line">    <span class="string">&#x27;title&#x27;</span>: [],</span><br><span class="line"><span class="comment">#     没用</span></span><br><span class="line">    <span class="string">&#x27;dtype&#x27;</span>: [],</span><br><span class="line"><span class="comment">#     目标网址链接</span></span><br><span class="line">    <span class="string">&#x27;urlhref&#x27;</span>: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36 Edg/98.0.1108.56&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#对网址发起请求</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">23</span>)):</span><br><span class="line">    baseurl = <span class="string">&#x27;http://www.safehoo.com&#x27;</span></span><br><span class="line">    url = baseurl + <span class="string">f&#x27;/Case/Case/Collapse/List_<span class="subst">&#123;i&#125;</span>.shtml&#x27;</span></span><br><span class="line">    <span class="comment">#网址先包含了对浏览器的检测,要加入headers</span></span><br><span class="line">    res = requests.get(url, headers=headers)</span><br><span class="line">    <span class="comment">#转化格式,防止乱码出现</span></span><br><span class="line">    res.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    html = etree.HTML(res.text)</span><br><span class="line">    a = html.xpath(<span class="string">&#x27;//div[@class=&quot;childclass_content&quot;]/li&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="comment"># 标题,进行异常检测</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tempdict[<span class="string">&#x27;title&#x27;</span>].append(i.xpath(<span class="string">&#x27;./a/text()&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            tempdict[<span class="string">&#x27;title&#x27;</span>].append(i.xpath(<span class="string">&#x27;./a/font/text()&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># 类型</span></span><br><span class="line">        tempdict[<span class="string">&#x27;dtype&#x27;</span>].append(re.sub(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>,re.sub(<span class="string">&#x27;[A-Za-z0-9\!\%\[\]\,\。]&#x27;</span>,<span class="string">&#x27;&#x27;</span>,i.xpath(<span class="string">&#x27;./text()&#x27;</span>)[<span class="number">0</span>])))</span><br><span class="line">        <span class="comment"># 地址</span></span><br><span class="line">        tempdict[<span class="string">&#x27;urlhref&#x27;</span>].append(baseurl+i.xpath(<span class="string">&#x27;./a/@href&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">        </span><br><span class="line"><span class="comment">#将数据转化为数据框格式</span></span><br><span class="line">df = pd.DataFrame(tempdict)</span><br><span class="line"><span class="comment">#将数据保存到excel里面</span></span><br><span class="line">df.to_excel(<span class="string">&#x27;output.xlsx&#x27;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内容爬取</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;output.xlsx&#x27;</span>)</span><br><span class="line">url = df[<span class="string">&#x27;urlhref&#x27;</span>]</span><br><span class="line">df[<span class="string">&#x27;result&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36 Edg/98.0.1108.56&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="built_in">len</span>(url))):</span><br><span class="line">    res = requests.get(url[i], headers=headers)</span><br><span class="line">    res.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    html = etree.HTML(res.text)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        item = html.xpath(<span class="string">&#x27;//*[@id=&quot;prt2&quot;]/div&#x27;</span>)[<span class="number">0</span>].xpath(<span class="string">&#x27;string(.)&#x27;</span>)</span><br><span class="line">        result = re.sub(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>, re.sub(<span class="string">&#x27;\r\n &#x27;</span>, <span class="string">&#x27;&#x27;</span>, item))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        result = <span class="literal">None</span></span><br><span class="line">    df[<span class="string">&#x27;result&#x27;</span>][i] = result</span><br><span class="line"></span><br><span class="line">df.to_excel(<span class="string">&#x27;result.xlsx&#x27;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>总共获取了648条数据.</p>
<h6 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h6><p>到这里,我们获得了 如图所示数据,但是其中仍然包含大量的HTML文本,同时暂时还没将原因区分</p>
<p><img src="/2022/02/26/TF-IDF/image-20220226231431029.png" alt="image-20220226231431029"></p>
<p> 出来,因此,接下来需要采取正则的操作将文本规范化,同时将事故原因抽取出来.由于该网站的数据是以文档加pdf的形式展示的,因此在第一步先对pdf形式的文本进行一个去除.</p>
<p>直接采用pandas中notnull()的方法.去除后还剩下617条文本.</p>
<p>根据网站结构,我们可以知道,这里面的包含了很多结构化的信息,同时也包含了对原因的展示,在这里定义了一个函数,对网站的空字符,换行符以及Unicode编码进行了一个去除,接着针对标题所带的索引进行分块,然后依次遍历检索,若其中包含原因,那么该快就是对于该事故的原因解释.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_function</span>(<span class="params">text</span>):</span></span><br><span class="line">    type_list = [<span class="string">&quot;一&quot;</span>, <span class="string">&quot;二&quot;</span>, <span class="string">&quot;三&quot;</span>, <span class="string">&quot;四&quot;</span>, <span class="string">&quot;五&quot;</span>, <span class="string">&quot;六&quot;</span>, <span class="string">&quot;七&quot;</span>, <span class="string">&quot;八&quot;</span>, <span class="string">&quot;九&quot;</span>, <span class="string">&quot;十&quot;</span>]</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    text = text.replace(<span class="string">&#x27;\r&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\t&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\u3000&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(type_list)):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            temptext = re.findall(<span class="string">f&quot;<span class="subst">&#123;type_list[i]&#125;</span>、(.*?)<span class="subst">&#123;type_list[i+<span class="number">1</span>]&#125;</span>、&quot;</span>, text)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;概况&quot;</span> <span class="keyword">in</span> temptext <span class="keyword">or</span> <span class="string">&quot;结果&quot;</span> <span class="keyword">in</span> temptext:</span><br><span class="line">                result = result + <span class="string">&quot;事故概况:&quot;</span> + temptext.split(<span class="string">&#x27;。&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;原因&quot;</span> <span class="keyword">in</span> temptext:</span><br><span class="line">                result = result + <span class="string">&quot;事故原因&quot;</span> + temptext</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;概况&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="string">&quot;事故概况：&quot;</span> + text.split(<span class="string">&quot;。&quot;</span>)[<span class="number">0</span>] + result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;原因&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = result + <span class="string">&quot;事故原因&quot;</span> + <span class="string">&#x27;&#x27;</span>.join(text.split(<span class="string">&quot;。&quot;</span>)[<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_reason</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span>(text[<span class="number">1</span>]==<span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> text[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>    </span><br></pre></td></tr></table></figure>
<p><img src="/2022/02/26/TF-IDF/image-20220226233355724.png" alt="image-20220226233355724"></p>
<p>这里已经成功的将原因抽取出来了.</p>
<p>接着对筛取的结果进行进一步处理,最后将其转化为EXCEL存储.</p>
<h6 id="分词与词典构建"><a href="#分词与词典构建" class="headerlink" title="分词与词典构建"></a>分词与词典构建</h6><p>由于中文在处理时,首先第一步是要对其进行分词操作,同时由于新词的出现,因此需要用到行业相关的专用词典.</p>
<p>由于python在分词时需要用到txt格式的文件作为分词,目录,所以这里需要先将.scel格式的文件转化为txt格式的文件</p>
<p>.scel格式采用Unicode编码了汉字、拼音.</p>
<p>这里直接采取别人的解析程序:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 拼音表偏移</span></span><br><span class="line">startPy = <span class="number">0x1540</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 汉语词组表偏移</span></span><br><span class="line">startChinese = <span class="number">0x2628</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 全局拼音表</span></span><br><span class="line">GPy_Table = &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 解析结果</span></span><br><span class="line"><span class="comment"># 元组(词频,拼音,中文词组)的列表</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 原始字节码转为字符串</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2str</span>(<span class="params">data</span>):</span></span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        c = <span class="built_in">chr</span>(struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> c != <span class="built_in">chr</span>(<span class="number">0</span>):</span><br><span class="line">            <span class="built_in">str</span> += c</span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取拼音表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPyTable</span>(<span class="params">data</span>):</span></span><br><span class="line">    data = data[<span class="number">4</span>:]</span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        index = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos],data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">        lenPy = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">        py = byte2str(data[pos:pos + lenPy]) </span><br><span class="line">        GPy_Table[index] = py</span><br><span class="line">        pos += lenPy</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 获取一个词组的拼音</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWordPy</span>(<span class="params">data</span>):</span></span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    ret = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        index = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">        ret += GPy_Table[index]</span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 读取中文表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getChinese</span>(<span class="params">data</span>):</span></span><br><span class="line">    GTable = []</span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        <span class="comment"># 同音词数量</span></span><br><span class="line">        same = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 拼音索引表长度</span></span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">        py_table_len = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 拼音索引表</span></span><br><span class="line">        pos += <span class="number">2</span></span><br><span class="line">        py = getWordPy(data[pos: pos + py_table_len])</span><br><span class="line">        <span class="comment"># 中文词组</span></span><br><span class="line">        pos += py_table_len</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(same):</span><br><span class="line">            <span class="comment"># 中文词组长度</span></span><br><span class="line">            c_len = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 中文词组</span></span><br><span class="line">            pos += <span class="number">2</span></span><br><span class="line">            word = byte2str(data[pos: pos + c_len])</span><br><span class="line">            <span class="comment"># 扩展数据长度</span></span><br><span class="line">            pos += c_len</span><br><span class="line">            ext_len = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 词频</span></span><br><span class="line">            pos += <span class="number">2</span></span><br><span class="line">            count = struct.unpack(<span class="string">&#x27;H&#x27;</span>, <span class="built_in">bytes</span>([data[pos], data[pos + <span class="number">1</span>]]))[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            GTable.append((count, py, word))</span><br><span class="line">            <span class="comment"># 到下个词的偏移位置</span></span><br><span class="line">            pos += ext_len</span><br><span class="line">    <span class="keyword">return</span> GTable</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scel2txt</span>(<span class="params">file_name</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">60</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;词库名：&quot;</span>, byte2str(data[<span class="number">0x130</span>:<span class="number">0x338</span>])) <span class="comment"># .encode(&#x27;GB18030&#x27;)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;词库类型：&quot;</span>, byte2str(data[<span class="number">0x338</span>:<span class="number">0x540</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;描述信息：&quot;</span>, byte2str(data[<span class="number">0x540</span>:<span class="number">0xd40</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;词库示例：&quot;</span>, byte2str(data[<span class="number">0xd40</span>:startPy]))</span><br><span class="line">    getPyTable(data[startPy:startChinese])</span><br><span class="line">    getChinese(data[startChinese:])</span><br><span class="line">    <span class="keyword">return</span> getChinese(data[startChinese:])</span><br><span class="line"></span><br><span class="line"><span class="comment"># scel所在文件夹路径</span></span><br><span class="line">in_path = <span class="string">&#x27;./专业词词库&#x27;</span></span><br><span class="line"><span class="comment"># 输出词典所在文件夹路径</span></span><br><span class="line">out_path = <span class="string">&#x27;./词库&#x27;</span></span><br><span class="line">fin = [fname <span class="keyword">for</span> fname <span class="keyword">in</span> os.listdir(in_path) <span class="keyword">if</span> fname[-<span class="number">5</span>:] == <span class="string">&quot;.scel&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> fin:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> scel2txt(os.path.join(in_path, f)):</span><br><span class="line">            file_path=(os.path.join(out_path, <span class="built_in">str</span>(f).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;.txt&#x27;</span>))</span><br><span class="line">            <span class="comment"># 保存结果</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)<span class="keyword">as</span> file:</span><br><span class="line">                file.write(word[<span class="number">2</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        os.remove(os.path.join(in_path, f))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>接着在对上述生成的txt文本进行一个合并操作,最终生成了一个自定义词典.</p>
<p>然后采用jieba分词,将其转化为词的形式.</p>
<h6 id="数据集处理"><a href="#数据集处理" class="headerlink" title="数据集处理"></a>数据集处理</h6><p>采取上述爬取的数据集和人工收集到的第二份数据集进行合并,由于分析对象选取的是2007年以后,所以针对其进行了进一步的筛选操作.还剩余425条数据.</p>
<h6 id="模型导入"><a href="#模型导入" class="headerlink" title="模型导入"></a>模型导入</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#TfidfVectorizer为上述CountVectorizer,TfidfTransformer的集合</span></span><br><span class="line">vector = TfidfVectorizer(stop_words=stoplist, vocabulary = vocab)</span><br><span class="line">tf_idf = vector.fit_transform(corpus)</span><br></pre></td></tr></table></figure>
<p>由于文章包含大量描述性的话语，同时存在多个词语指代同一词语的现象，因此，在此基础上，对停用词词典进行进一步调整，然后根据top50的词频，将其跟原因相关的词汇进行分类，将原因分为如下四类:</p>
<ul>
<li>安全因素:’安全生产’,’安全管理’,’安全隐患’,’培训’,’安全生产工作’,’现场安全管理’,’教育’</li>
<li>管理因素:’管理’,’监理’,’组织’,’落实’,’履行’,’监督’,’协调’,’混乱’,’监督管理’,’审批’</li>
<li>工作因素:’检查’,’排查’,’违反’,’整改’, ‘拆除’,’调查’,’发现’,’验收’</li>
<li>其他因素’隐患’,’分包’,’救援’,’临时’</li>
</ul>
<p>同时将其词频分布以词云图的形式展现。</p>
<p><img src="/2022/02/26/TF-IDF/image-20220227153628664.png" alt="image-20220227153628664"></p>
<p><img src="/2022/02/26/TF-IDF/image-20220227161321175.png" alt="image-20220227161321175"></p>
<p>最后将其结果以上述关键词进行一个分类。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lan</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">158k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">2:24</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
