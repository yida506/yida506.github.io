<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yida506.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="spider">
<meta property="og:url" content="http://yida506.github.io/index.html">
<meta property="og:site_name" content="spider">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Lan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yida506.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>spider</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">spider</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/04/23/Android%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/Android%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">Android基础</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="APP介绍"><a href="#APP介绍" class="headerlink" title="APP介绍"></a>APP介绍</h3><h5 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h5><p>直接在android中创建一个hello world项目。</p>
<p><img src="/2022/04/23/Android%E5%9F%BA%E7%A1%80/image-20220425230616509.png" alt="image-20220425230616509"></p>
<p>可以看到包含很多内容，这里的java 里面有一个应用名称目录，其中包含了MainActivity,</p>
<p>Android项目的资源会被存储在res文件夹中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在MainActivity中，基础了一个基础的Activity类，然后又重写了这个onCreate方法，最后设置了layout.activity_main为View.</p>
<p><img src="/2022/04/23/Android%E5%9F%BA%E7%A1%80/image-20220425232435459.png" alt="image-20220425232435459"></p>
<p>这里编写了hello world 然后渲染到了app主界面上.</p>
<h6 id="点击事件添加"><a href="#点击事件添加" class="headerlink" title="点击事件添加"></a>点击事件添加</h6><p>直接修改TextView为Button,然后添加id属性(“@+id/check”)即可。</p>
<p>然后在MainActivity中添加如下代码，绑定button按钮并添加事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Button bt_check = findViewById(R.id.check);</span><br><span class="line">        bt_check.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Log.i(<span class="string">&quot;rousue&quot;</span>, <span class="string">&quot;hello world from button&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/23/Android%E5%9F%BA%E7%A1%80/image-20220426231939847.png" alt="image-20220426231939847"></p>
<p>这样一来每次点击在后台返回了日志。</p>
<h6 id="Android组成部分"><a href="#Android组成部分" class="headerlink" title="Android组成部分"></a>Android组成部分</h6><ul>
<li>Activity 表示层 展示UI，响应用户动作</li>
<li>Service 更新数据源和Activity</li>
<li>Content Provider 数据储存器</li>
<li>Intent 消息传递框架</li>
<li>Broadcast Receiver Intet监听器</li>
<li>Widget 可视化组件</li>
<li>Notification 向用户发起信号</li>
</ul>
<blockquote>
<p>Manifest存储在最底层，定义应用程序的组件和需求的结构和元数据。</p>
</blockquote>
<h5 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h5><p>该类为所有用户界面的基础。</p>
<p>每一个Activity都表示一个屏幕，类似web中的html</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/04/21/Frida/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/21/Frida/" class="post-title-link" itemprop="url">Frida</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Frida基础"><a href="#Frida基础" class="headerlink" title="Frida基础"></a>Frida基础</h4><h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su </span><br><span class="line">cd /data/local/tmp/</span><br><span class="line">./对应frida-serve的名字+&amp;</span><br></pre></td></tr></table></figure>
<h5 id="HOOK"><a href="#HOOK" class="headerlink" title="HOOK"></a>HOOK</h5><h6 id="python"><a href="#python" class="headerlink" title="python"></a>python</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@author: lan</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@contact: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@Created on: 2022/4/20 19:54</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test_signature = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	js代码</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动方式1 attachH后跟进程名</span></span><br><span class="line">process = frida.get_usb_device(-<span class="number">1</span>).attach(<span class="string">&#x27;com.chaozhuo.texteditor&#x27;</span>)</span><br><span class="line">script = process.create_script(test_signature)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>本质上写Js代码即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">process = frida.get_usb_device().enumerate_processes()</span><br><span class="line"><span class="comment">#可以查看当前运行的进程名</span></span><br><span class="line"><span class="built_in">print</span>(process)</span><br></pre></td></tr></table></figure>
<p>也可以直接adb查看进程，这里条件可以任意，为com.xxx皆可，目的是缩小范围. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell &quot;ps | grep 条件&quot;</span><br></pre></td></tr></table></figure>
<h6 id="重载的代码hook"><a href="#重载的代码hook" class="headerlink" title="重载的代码hook"></a>重载的代码hook</h6><p><img src="/2022/04/21/Frida/image-20220423112839478.png" alt="image-20220423112839478"></p>
<p>以该处为例，该类中有两个a方法，我们只想hook上面一个，直接写就会报错。</p>
<p><img src="/2022/04/21/Frida/image-20220423113034693.png" alt="image-20220423113034693"></p>
<p>这样，我们只需要等他报错后，修改代码即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加上.overload(&#x27;a.u$a&#x27;)</span></span><br><span class="line">Signature.a.overload(<span class="string">&#x27;a.u$a&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;enter a&#x27;</span>);    </span><br><span class="line">            <span class="built_in">console</span>.log(val);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.a(val);</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>
<h6 id="js"><a href="#js" class="headerlink" title="js"></a>js</h6><p>也可以考虑直接编写js脚本进行frida.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 打印出当前手机上的进程</span><br><span class="line">frida-ps -Ua</span><br><span class="line">//后面的是进程名，只需要在jsl</span><br><span class="line">frida -U -l test.js com.example.simpleencryption</span><br></pre></td></tr></table></figure>
<p>后续思路，直接找出python算法还原，对比，重写为python算法。</p>
<p>静态方法可以直接调用。</p>
<h5 id="Objection"><a href="#Objection" class="headerlink" title="Objection"></a>Objection</h5><p>Objection本质上是frida的一种工具实现，可以通过命令行输出，实现frida交互过程，达到类调用，hook的目的。</p>
<h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><p>由于frida版本是14.1.3，直接pip install objection即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/04/19/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">静态分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="jadx使用"><a href="#jadx使用" class="headerlink" title="jadx使用"></a>jadx使用</h4><p>直接用jadx打开apk。</p>
<h4 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h4><h5 id="1-代码搜索"><a href="#1-代码搜索" class="headerlink" title="1.代码搜索"></a>1.代码搜索</h5><p><img src="/2022/04/19/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/image-20220419214843370.png" alt="image-20220419214843370"></p>
<p>activity里面包含主要代码。其中在main之前的为主界面代码，这里只有mainActivity.</p>
<p><img src="/2022/04/19/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/image-20220419215044951.png" alt="image-20220419215044951"></p>
<p>onCreate、onClick为事件。</p>
<h4 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h4><h5 id="启动："><a href="#启动：" class="headerlink" title="启动："></a>启动：</h5><p>连接到手机后，进入安装frida-serve的位置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su </span><br><span class="line">cd /data/local/tmp/</span><br></pre></td></tr></table></figure>
<p>ps -A | grep com</p>
<p>com指代的是过滤条件，该指令可以展示当前进程名，也对应下图xml中的package名。</p>
<p><img src="/2022/04/19/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/image-20220419221411727.png" alt="image-20220419221411727"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#模板</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="comment">#这里写要hook代码</span></span><br><span class="line">test_t=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Java.perform(</span></span><br><span class="line"><span class="string">    function()&#123;</span></span><br><span class="line"><span class="string">        var MainActivity = Java.use(&#x27;com.example.seccon2015.rock_paper_scissors.MainActivity&#x27;)</span></span><br><span class="line"><span class="string">        MainActivity.onClick.implementation = function(val)&#123;</span></span><br><span class="line"><span class="string">            console.log(&#x27;mmmm:&#x27;+this.m.value);</span></span><br><span class="line"><span class="string">            console.log(this.n.value);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            this.onClick(val);</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        #下面是匿名类的hook方法,这里要把他自带的.改为$</span></span><br><span class="line"><span class="string">         var test = Java.use(&#x27;com.example.seccon2015.rock_paper_scissors.MainActivity$1&#x27;)</span></span><br><span class="line"><span class="string">        test.run.implementation = function()&#123;</span></span><br><span class="line"><span class="string">            console.log(&#x27;this is test&#x27;);</span></span><br><span class="line"><span class="string">            this.run();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#模板</span></span><br><span class="line"><span class="comment">#启动方式1 attachH后跟进程名</span></span><br><span class="line">process = frida.get_usb_device(-<span class="number">1</span>).attach(<span class="string">&#x27;com.example.seccon2015.rock_paper_scissors&#x27;</span>)</span><br><span class="line">script = process.create_script(test_t)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<p>匿名类可以通过smali代码判断。</p>
<p>在匿名函数访问外部类：<br>this.this$0.value.xxx.value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#打印调用堆栈</span><br><span class="line">function printstack()&#123;</span><br><span class="line">    console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Exception&quot;).$new()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/04/03/app%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/03/app%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">app入门</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>509</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h4><p>手机选择 nexus 5</p>
<p>刷机包下载：</p>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/android/images#bullhead">https://developers.google.com/android/images#bullhead</a></p>
<p>选择版本 OPM1.171019.011, Dec 2017</p>
<p><strong>win10需要更新google usb driver </strong></p>
<blockquote>
<p><img src="/2022/04/03/app%E5%85%A5%E9%97%A8/image-20220417122821654.png" alt="image-20220417122821654"></p>
</blockquote>
<p>然后直接运行</p>
<p><img src="/2022/04/03/app%E5%85%A5%E9%97%A8/image-20220417135832286.png" alt="image-20220417135832286"></p>
<p>即可</p>
<h4 id="ROOT"><a href="#ROOT" class="headerlink" title="ROOT"></a>ROOT</h4><p>去下一个TWRP镜像，</p>
<p>然后用fastboot falsh  recovery twrp镜像推送镜像 ，然后从bootloaders界面进去recovery分区，安装twrp</p>
<p><a target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk/releases/tag/v20.4">https://github.com/topjohnwu/Magisk/releases/tag/v20.4</a></p>
<p>下载magisk包</p>
<p>然后通过adb push Magisk-v20.4.zip /sdcard/ 推送到手机上</p>
<p>这里sdcard指代的是默认目录。</p>
<p>然后通过twrp的install找到传输过来的zip进行安装。</p>
<p><img src="/2022/04/03/app%E5%85%A5%E9%97%A8/image-20220417144216066.png" alt="image-20220417144216066"></p>
<p>adb shell 连接手机, su是进入root权限.</p>
<h4 id="Frida安装"><a href="#Frida安装" class="headerlink" title="Frida安装"></a>Frida安装</h4><p>直接pip安装 有点慢 会卡在setup处</p>
<p>然后安装frida-tools 版本要对应</p>
<p>接着暗转frida-server push到手机上</p>
<h4 id="JADX"><a href="#JADX" class="headerlink" title="JADX"></a>JADX</h4><p>命令行运行 java -jar jadx-gui-1.3.4.jar (在jadx的lib中)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/21/%E6%8A%96%E9%9F%B3web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/21/%E6%8A%96%E9%9F%B3web/" class="post-title-link" itemprop="url">抖音web</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>mysql+redis</p>
<h4 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h4><p>需要建立三次握手，断开需要建立四次握手。</p>
<p><img src="/2022/03/21/%E6%8A%96%E9%9F%B3web/image-20220326225236374.png" alt="image-20220326225236374"></p>
<p>连接过程：Client(客户端)发送连接请求SYN报文，Server段接受连接后回复ACK报文，然后分配资源，客户端接收ACK报文后，也向服务端发送ACK报文，分配资源，然后就建立了TCP连接</p>
<p>断开连接：客户端发送FIN报文，假如数据还没传完，服务端继续发送ACK报文，之后在发送FIN报文给客户端，然后客户端再发ACK报文回来(告诉服务器可以关闭了)，然后就关闭了TCP连接。</p>
<h4 id="WebSocket协议"><a href="#WebSocket协议" class="headerlink" title="WebSocket协议"></a>WebSocket协议</h4><p>实现了浏览器与服务器全双工通信(full-duplex)。只需要建立一次连接，就可以一直保持连接状态，并且前后端可以互相通信，不再是单向的了。</p>
<blockquote>
<p>简单来讲，就是可以直接搭建起双向连接机制，</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/egrep/p/9546275.html">WebSocket的原理,及如何测试websocket是否连接成功 - Egrep - 博客园 (cnblogs.com)</a></p>
<h4 id="目标网站"><a href="#目标网站" class="headerlink" title="目标网站"></a>目标网站</h4><p><a target="_blank" rel="noopener" href="https://www.douyin.com/user/MS4wLjABAAAAeHJ41sMLJQv06KFI-PyqxocoipBl5AKhEV8EROp7HZU">https://www.douyin.com/user/MS4wLjABAAAAeHJ41sMLJQv06KFI-PyqxocoipBl5AKhEV8EROp7HZU</a></p>
<p>RPC注入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SekiroClient</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.wsURL = wsURL;</span><br><span class="line">    <span class="built_in">this</span>.handlers = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.socket = &#123;&#125;;</span><br><span class="line">    <span class="comment">// check</span></span><br><span class="line">    <span class="keyword">if</span> (!wsURL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;wsURL can not be empty!!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.webSocketFactory = <span class="built_in">this</span>.resolveWebSocketFactory();</span><br><span class="line">    <span class="built_in">this</span>.connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.resolveWebSocketFactory = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> theWebSocket = <span class="built_in">window</span>.WebSocket ? <span class="built_in">window</span>.WebSocket : <span class="built_in">window</span>.MozWebSocket;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">WindowWebSocketWrapper</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket = <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.close = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.close();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">onMessageFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onmessage = onMessageFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">onOpenFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onopen = onOpenFunction;</span><br><span class="line">            &#125;;</span><br><span class="line">            WindowWebSocketWrapper.prototype.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">onCloseFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onclose = onCloseFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.send(message);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowWebSocketWrapper(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> weex === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// this is weex env : https://weex.apache.org/zh/docs/modules/websockets.html</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;test webSocket for weex&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> ws = weex.requireModule(<span class="string">&#x27;webSocket&#x27;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;find webSocket for weex:&quot;</span> + ws);</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ws.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                ws.WebSocket(wsURL, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> ws;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(e);</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO support ReactNative</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> WebSocket === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weex å’Œ PCçŽ¯å¢ƒçš„websocket APIä¸å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥åšäº†æŠ½è±¡å…¼å®¹</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;the js environment do not support websocket&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.connect = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: begin of connect to wsURL: &#x27;</span> + <span class="built_in">this</span>.wsURL);</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">// ä¸check closeï¼Œè®©</span></span><br><span class="line">    <span class="comment">// if (this.socket &amp;&amp; this.socket.readyState === 1) &#123;</span></span><br><span class="line">    <span class="comment">//     this.socket.close();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = <span class="built_in">this</span>.webSocketFactory(<span class="built_in">this</span>.wsURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: create connection failed,reconnect after 2s&quot;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onmessage(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        _this.handleSekiroRequest(event.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onopen(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: open a sekiro client connection&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onclose(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: disconnected ,reconnection after 2s&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.handleSekiroRequest = <span class="function"><span class="keyword">function</span> (<span class="params">requestJson</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;receive sekiro request: &quot;</span> + requestJson);</span><br><span class="line">    <span class="keyword">var</span> request = <span class="built_in">JSON</span>.parse(requestJson);</span><br><span class="line">    <span class="keyword">var</span> seq = request[<span class="string">&#x27;__sekiro_seq__&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!request[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;need request param &#123;action&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> action = request[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.handlers[action]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;no action handler: &#x27;</span> + action + <span class="string">&#x27; defined&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> theHandler = <span class="built_in">this</span>.handlers[action];</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        theHandler(request, <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                _this.sendSuccess(seq, response)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                _this.sendFailed(seq, <span class="string">&quot;e:&quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">errorMessage</span>) </span>&#123;</span><br><span class="line">            _this.sendFailed(seq, errorMessage)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;error: &quot;</span> + e);</span><br><span class="line">        _this.sendFailed(seq, <span class="string">&quot;:&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendSuccess = <span class="function"><span class="keyword">function</span> (<span class="params">seq, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> responseJson;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseJson = <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            responseJson = &#123;&#125;;</span><br><span class="line">            responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        responseJson = response;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson = &#123;&#125;;</span><br><span class="line">        responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(responseJson)) &#123;</span><br><span class="line">        responseJson = &#123;</span><br><span class="line">            <span class="attr">data</span>: responseJson,</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseJson[<span class="string">&#x27;code&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;code&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseJson[<span class="string">&#x27;status&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendFailed = <span class="function"><span class="keyword">function</span> (<span class="params">seq, errorMessage</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> errorMessage != <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        errorMessage = <span class="built_in">JSON</span>.stringify(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> responseJson = &#123;&#125;;</span><br><span class="line">    responseJson[<span class="string">&#x27;message&#x27;</span>] = errorMessage;</span><br><span class="line">    responseJson[<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.registerAction = <span class="function"><span class="keyword">function</span> (<span class="params">action, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;an action must be string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handler !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;a handler must be function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: register action: &quot;</span> + action);</span><br><span class="line">    <span class="built_in">this</span>.handlers[action] = handler;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">S4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                  <span class="keyword">return</span> (((<span class="number">1</span>+<span class="built_in">Math</span>.random())*<span class="number">0x10000</span>)|<span class="number">0</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (S4()+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+S4()+S4());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> SekiroClient(<span class="string">&quot;ws://127.0.0.1:5620/business-demo/register?group=dy&amp;clientId=&quot;</span>+guid());</span><br><span class="line"></span><br><span class="line">client.registerAction(<span class="string">&quot;getSignature&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">request, resolve,reject </span>)</span>&#123;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">let</span> pageurl = <span class="string">&#x27;/aweme/v1/web/aweme/post/?device_platform=webapp&amp;aid=6383&amp;channel=channel_pc_web&amp;sec_user_id=MS4wLjABAAAAGyky76MpsaNiuI6tNX0dogABIPR8P_Od0YV7cGD_9P0&amp;max_cursor=1645674431000&amp;locate_query=false&amp;count=10&amp;publish_video_strategy_type=2&amp;version_code=170400&amp;version_name=17.4.0&amp;cookie_enabled=true&amp;screen_width=1920&amp;screen_height=1080&amp;browser_language=en-US&amp;browser_platform=Win32&amp;browser_name=Chrome&amp;browser_version=99.0.4844.74&amp;browser_online=true&amp;engine_name=Blink&amp;engine_version=99.0.4844.74&amp;os_name=Windows&amp;os_version=10&amp;cpu_core_num=8&amp;device_memory=8&amp;platform=PC&amp;downlink=10&amp;effective_type=4g&amp;round_trip_time=50&amp;webid=7077786468781164044&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendAjax</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest;</span><br><span class="line"></span><br><span class="line">                xhr.responseType = <span class="string">&quot;json&quot;</span>;</span><br><span class="line">                xhr.open(<span class="string">&#x27;get&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">                xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">                    resolve(xhr[<span class="string">&#x27;response&#x27;</span>][<span class="string">&#x27;aweme_list&#x27;</span>]);</span><br><span class="line">                    <span class="keyword">if</span>( <span class="built_in">this</span>.status == <span class="number">200</span> || <span class="built_in">this</span>.status == <span class="number">304</span>)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(xhr.responseURL);</span><br><span class="line">                            <span class="built_in">console</span>.log(xhr.responseType);</span><br><span class="line">                            <span class="keyword">return</span> xhr[<span class="string">&#x27;response&#x27;</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                xhr.send(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sendAjax(pageurl);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/20/jsrpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/20/jsrpc/" class="post-title-link" itemprop="url">jsrpc</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="JSRPC"><a href="#JSRPC" class="headerlink" title="JSRPC"></a>JSRPC</h4><p>安装websocket服务</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> nodejs-websocket</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="built_in">require</span>(<span class="string">&quot;nodejs-websocket&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> _server = ws.createServer(<span class="function"><span class="params">conn</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 接收客户端返回的数据</span></span><br><span class="line">	conn.on(<span class="string">&quot;text&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(str, <span class="string">&quot;接收客户端传过来的值&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端关闭连接</span></span><br><span class="line">	conn.on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	conn.on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">		<span class="comment">//error</span></span><br><span class="line">		<span class="built_in">console</span>.log(err, <span class="string">&quot;连接报错&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8015</span>;</span><br><span class="line">_server.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;连接成功&quot;</span>)</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;listening on websocketServer&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>建立连接后，就可以用python和浏览器来回传递信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">ws = websocket.WebSocketApp(<span class="string">&#x27;ws://127.0.0.1:8015&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">ws, message</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message.split(<span class="string">&#x27;_&#x27;</span>)[<span class="number">0</span>] != <span class="string">&#x27;js&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">ws.on_message = on_message</span><br><span class="line">ws.run_forever()</span><br></pre></td></tr></table></figure>
<p>浏览器注入，建立通信</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket)&#123;</span><br><span class="line">		ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://127.0.0.1:8015/&#x27;</span>);</span><br><span class="line">		ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;服务器关闭&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;连接出错&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e)</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>注入后和js的websocketServer建立了双向连接，然后就形成了通信。</p>
<p><img src="/2022/03/20/jsrpc/image-20220320171420496.png" alt="image-20220320171420496"></p>
<p>这样，就可以在浏览器中通过send，进行调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SekiroClient</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.wsURL = wsURL;</span><br><span class="line">    <span class="built_in">this</span>.handlers = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.socket = &#123;&#125;;</span><br><span class="line">    <span class="comment">// check</span></span><br><span class="line">    <span class="keyword">if</span> (!wsURL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;wsURL can not be empty!!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.webSocketFactory = <span class="built_in">this</span>.resolveWebSocketFactory();</span><br><span class="line">    <span class="built_in">this</span>.connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.resolveWebSocketFactory = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> theWebSocket = <span class="built_in">window</span>.WebSocket ? <span class="built_in">window</span>.WebSocket : <span class="built_in">window</span>.MozWebSocket;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">WindowWebSocketWrapper</span>(<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket = <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.close = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.close();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">onMessageFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onmessage = onMessageFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">onOpenFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onopen = onOpenFunction;</span><br><span class="line">            &#125;;</span><br><span class="line">            WindowWebSocketWrapper.prototype.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">onCloseFunction</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.onclose = onCloseFunction;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            WindowWebSocketWrapper.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.mSocket.send(message);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowWebSocketWrapper(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> weex === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// this is weex env : https://weex.apache.org/zh/docs/modules/websockets.html</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;test webSocket for weex&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> ws = weex.requireModule(<span class="string">&#x27;webSocket&#x27;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;find webSocket for weex:&quot;</span> + ws);</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ws.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                ws.WebSocket(wsURL, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> ws;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(e);</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO support ReactNative</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> WebSocket === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">wsURL</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> theWebSocket(wsURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weex å’Œ PCçŽ¯å¢ƒçš„websocket APIä¸å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥åšäº†æŠ½è±¡å…¼å®¹</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;the js environment do not support websocket&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.connect = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: begin of connect to wsURL: &#x27;</span> + <span class="built_in">this</span>.wsURL);</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">// ä¸check closeï¼Œè®©</span></span><br><span class="line">    <span class="comment">// if (this.socket &amp;&amp; this.socket.readyState === 1) &#123;</span></span><br><span class="line">    <span class="comment">//     this.socket.close();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = <span class="built_in">this</span>.webSocketFactory(<span class="built_in">this</span>.wsURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: create connection failed,reconnect after 2s&quot;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onmessage(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        _this.handleSekiroRequest(event.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onopen(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: open a sekiro client connection&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.socket.onclose(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;sekiro: disconnected ,reconnection after 2s&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            _this.connect()</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.handleSekiroRequest = <span class="function"><span class="keyword">function</span> (<span class="params">requestJson</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;receive sekiro request: &quot;</span> + requestJson);</span><br><span class="line">    <span class="keyword">var</span> request = <span class="built_in">JSON</span>.parse(requestJson);</span><br><span class="line">    <span class="keyword">var</span> seq = request[<span class="string">&#x27;__sekiro_seq__&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!request[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;need request param &#123;action&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> action = request[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.handlers[action]) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendFailed(seq, <span class="string">&#x27;no action handler: &#x27;</span> + action + <span class="string">&#x27; defined&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> theHandler = <span class="built_in">this</span>.handlers[action];</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        theHandler(request, <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                _this.sendSuccess(seq, response)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                _this.sendFailed(seq, <span class="string">&quot;e:&quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">errorMessage</span>) </span>&#123;</span><br><span class="line">            _this.sendFailed(seq, errorMessage)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;error: &quot;</span> + e);</span><br><span class="line">        _this.sendFailed(seq, <span class="string">&quot;:&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendSuccess = <span class="function"><span class="keyword">function</span> (<span class="params">seq, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> responseJson;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseJson = <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            responseJson = &#123;&#125;;</span><br><span class="line">            responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> response == <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        responseJson = response;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson = &#123;&#125;;</span><br><span class="line">        responseJson[<span class="string">&#x27;data&#x27;</span>] = response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(responseJson)) &#123;</span><br><span class="line">        responseJson = &#123;</span><br><span class="line">            <span class="attr">data</span>: responseJson,</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseJson[<span class="string">&#x27;code&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;code&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseJson[<span class="string">&#x27;status&#x27;</span>]) &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        responseJson[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.sendFailed = <span class="function"><span class="keyword">function</span> (<span class="params">seq, errorMessage</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> errorMessage != <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        errorMessage = <span class="built_in">JSON</span>.stringify(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> responseJson = &#123;&#125;;</span><br><span class="line">    responseJson[<span class="string">&#x27;message&#x27;</span>] = errorMessage;</span><br><span class="line">    responseJson[<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>;</span><br><span class="line">    responseJson[<span class="string">&#x27;__sekiro_seq__&#x27;</span>] = seq;</span><br><span class="line">    <span class="keyword">var</span> responseText = <span class="built_in">JSON</span>.stringify(responseJson);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: response :&quot;</span> + responseText);</span><br><span class="line">    <span class="built_in">this</span>.socket.send(responseText)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SekiroClient.prototype.registerAction = <span class="function"><span class="keyword">function</span> (<span class="params">action, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;an action must be string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handler !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;a handler must be function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;sekiro: register action: &quot;</span> + action);</span><br><span class="line">    <span class="built_in">this</span>.handlers[action] = handler;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">S4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                  <span class="keyword">return</span> (((<span class="number">1</span>+<span class="built_in">Math</span>.random())*<span class="number">0x10000</span>)|<span class="number">0</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (S4()+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+<span class="string">&quot;-&quot;</span>+S4()+S4()+S4());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> SekiroClient(<span class="string">&quot;ws://127.0.0.1:5620/business-demo/register?group=ws-group&amp;clientId=&quot;</span>+guid());</span><br><span class="line"></span><br><span class="line">client.registerAction(<span class="string">&quot;clientTime&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">request, resolve,reject </span>)</span>&#123;</span><br><span class="line">            <span class="comment">//在这里div</span></span><br><span class="line">            resolve(<span class="string">&quot;&quot;</span>+<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sekiro框架注入Js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5620/business-demo/invoke?group=****&amp;action=****&amp;page=(这里选用要传的值)</span><br></pre></td></tr></table></figure>
<p>这里的group对应上面的组，action对应其调用的方法，这里是clientTime;</p>
<p>若要传值，可以采用类似python</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/13/ali/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/ali/" class="post-title-link" itemprop="url">ali</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 id="三重控制流平坦化"><a href="#三重控制流平坦化" class="headerlink" title="三重控制流平坦化"></a>三重控制流平坦化</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> e = <span class="number">1</span>; <span class="keyword">void</span> <span class="number">0</span> !== e;) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">7</span> &amp; e;</span><br><span class="line">    <span class="keyword">var</span> r = e &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="number">7</span> &amp; r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (a) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">switch</span> (s) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            i += <span class="string">&quot;a&quot;</span>;</span><br><span class="line">            e = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (i) &#123;</span><br><span class="line">              e = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              e = <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            i += <span class="string">&quot;hB&quot;</span>;</span><br><span class="line">            e = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">var</span> c = <span class="string">&quot;egdirbsj&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> b = c.split(<span class="string">&quot;&quot;</span>).reverse().join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> k = j[b];</span><br><span class="line">        <span class="keyword">var</span> o = !k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (o) &#123;</span><br><span class="line">          e = <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        i += <span class="string">&quot;ck&quot;</span>;</span><br><span class="line">        d(<span class="number">15</span>, <span class="number">0</span>, k, i, t);</span><br><span class="line">        <span class="keyword">return</span> !<span class="number">0</span>;</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">var</span> t = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> a = e[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">var</span> r = <span class="string">&quot;\u03a2\u03c3\u03b7\u03de\u03a8\u03cd\u03f7&quot;</span>;</span><br><span class="line">          <span class="keyword">var</span> s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          <span class="keyword">var</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> b = <span class="number">0</span>; b &lt; r.length; b++) &#123;</span><br><span class="line">            b || (c = <span class="number">972</span>);</span><br><span class="line">            <span class="keyword">var</span> k = r.charCodeAt(b);</span><br><span class="line">            <span class="keyword">var</span> o = k ^ c;</span><br><span class="line">            c = k;</span><br><span class="line">            s += <span class="built_in">String</span>.fromCharCode(o);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> t = a === s;</span><br><span class="line">          t &amp;&amp; d(<span class="number">0</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> i = <span class="string">&quot;pus&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i) &#123;</span><br><span class="line">          e = <span class="number">16</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">var</span> n = <span class="string">&quot;def&quot;</span>;</span><br><span class="line">        n += <span class="string">&quot;ault&quot;</span>;</span><br><span class="line">        k = k[n];</span><br><span class="line">        <span class="keyword">var</span> h = !k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (h) &#123;</span><br><span class="line">          e = <span class="number">6</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          e = <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述为其模型的典型特征。</p>
<p>通过分析，我们可以发现，其中for循环中的test语句，为判断这个循环是否停止的条件，我们知道要使得for循环停止，可以添加break语句或者通过外嵌函数的方法，直接return出来，在这里我们可以看到，采用的是第二种方法，也就是说，在还原碰到return语句的时候，作为结束条件停止即可。</p>
<p><strong>大变量:指代这里的e</strong> </p>
<p><strong>初始化参数:指代这里的a、r、s</strong></p>
<ol>
<li><p>获取条件test表达式，获取初始化参数的值。</p>
</li>
<li><p>访问到最底部的节点，然后通过遍历的方式，获取其赋值语句，这里又分为两种情况：a.在当前层数可以找到最顶部参数的赋值语句的地方 b.在当前层数只能找到其上一节点的参数的赋值地方(应对多重switch嵌套)。</p>
<blockquote>
<p>思路，从初始for循环出发，初始化变量的值，然后根据SwitchStatement获取到当前变量及其对应的值，然后进入到case节点的位置，这里需要进行一个判断，判断其下一层是否还是SwitchStatemen类型，如果不是，那么就进行节点的合并，在这里面一定会包含一个关于初始值变化的位置，因此需要在这些Expressionstatement中找到其赋值表达式(Assignmentexpression)，然后在进行一次计算，但是在这种情况下，难免会碰到更深层的SwitchStatement，当游走到最深处的时候，需要判断，其是走向该Switch节点下的其他部分，还是赋值了大变量走入其他分支，最后根据return或者是结束语句判断是是否该for循环结束。</p>
</blockquote>
<p><strong>核心思路：将初始化和判断语句写入一个函数，这样可以做到一次获取全部初始变量的值，将所有的Switch节点均写为一个类似字典的形式，方便进入对应的节点。</strong> </p>
</li>
</ol>
<p><strong>但是，有个致命的问题就是IF表达式判断。</strong></p>
<p><img src="/2022/03/13/ali/image-20220314224908224.png" alt="image-20220314224908224"></p>
<p>通过对这里的分析，发现其本质上是走的一个for循环的流程，同时，其对应的else节点属于结束节点。</p>
<p>大胆假设，假如test节点的类型为BinaryExpression，同时其right部分为MemberExpression，而且其Identifier部分为length，那么这个就为for循环的test部分，同时其第一次stack包含的var声明式，在这里为var E = 0;代表for循环的起始值，其中有个流程包含E++对应for循环的自增值。本质上这是一个环形结构。</p>
<h5 id="流程梳理"><a href="#流程梳理" class="headerlink" title="流程梳理"></a>流程梳理</h5><h6 id="STEP1-运行步骤"><a href="#STEP1-运行步骤" class="headerlink" title="STEP1 运行步骤"></a>STEP1 运行步骤</h6><p>初始化b=4</p>
<p>{ k: 4, o: 0, t: 0, b: 4 }</p>
<p>进入该节点</p>
<p><img src="/2022/03/13/ali/image-20220317210749234.png" alt="image-20220317210749234"></p>
<p>然后碰到if流，根据变量名判断，这属于函数参数名，所以这两个分支应该都会走到，进入第一个b=8的分支。</p>
<p><img src="/2022/03/13/ali/image-20220317210938365.png" alt="image-20220317210938365"></p>
<p>发现，接下来走到的是b=0的分支。</p>
<p>{ k: 0, o: 0, t: 0, b: 0 }</p>
<p><img src="/2022/03/13/ali/image-20220317211033300.png" alt="image-20220317211033300"></p>
<p>接着又进入了一个if分支，可以发现，这里是对A的长度进行了一个判断，进入b=64分支，</p>
<p>{ k: 0, o: 4, t: 4, b: 64 }</p>
<p><img src="/2022/03/13/ali/image-20220317211633194.png" alt="image-20220317211633194"></p>
<p>先走32这个分支，给x赋值</p>
<p><img src="/2022/03/13/ali/image-20220317222822658.png" alt="image-20220317222822658"></p>
<p>即接下来走的是b=3这个分支。</p>
<p>{ k: 3, o: 0, t: 0, b: 3 } </p>
<p><img src="/2022/03/13/ali/image-20220317211912799.png" alt="image-20220317211912799"></p>
<p>然后又跳转到128分支</p>
<p>{ k: 0, o: 8, t: 8, b: 128 }</p>
<p><img src="/2022/03/13/ali/image-20220317212010367.png" alt="image-20220317212010367"></p>
<p>然后又跳回0分支，也就是说，继续重复上述步骤。</p>
<p>那么我们需要梳理其流程，然后对其进行一个还原，在这里可以看到，我们在进入b=0分支后先进行了一个对其长度判断，然后</p>
<p>进入一长串循环该步骤，最后跳出到b=2这个分支。</p>
<p>其初始头为b=0结束头为b=128.</p>
<p>我们最后希望将其还原为</p>
<p>var E=0</p>
<p>for(;E&lt;A.length;){</p>
<p>​    ……</p>
<p>​     E++;</p>
<p>}</p>
<p>的形式，后面跟的是b=2的分支。</p>
<h5 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h5><p><img src="/2022/03/13/ali/image-20220329225917160.png" alt="image-20220329225917160"></p>
<p>也就是说，在if的判断表达式为二元表达式，类似a&lt;b这种形式的时候，都是生成的for循环，这样假如采取栈的形式当下一次的初值和开始的初值相等，那么就可以退出，但是，这是对于单情况而言，假如其中嵌套if表达式，那么还需对其进行一个判断。</p>
<p>思路：</p>
<ol>
<li>if表达式的判断部分为二元表达式，进入for循环，此处对应的是该流程的外部参数，记录if表达式中左节点的参数名(该处一般为接下来进行更新操作的地方)。</li>
<li>进行接下来的流程操作，假如直接是与for循环开始节点一样的值，那么直接返回，但是，假如是经过一个if表达式，其中，if表达式的判断部分为一开始的左节点参数，一般，这个参数初始值为0，即，随着for循环的运行，这个值会进入不同的流程，那么这部分的If表达式的节点都需要保留，那么，就只有在else节点结束后，才算退出for循环。</li>
</ol>
<p>个人觉得，如果枚举全部情况，虽然还原后的结果看上去很好看，但是需要耗费大量的时间、精力，退而求其次，我们可以没必要一步到位，可以只还原if表达式，同时不对花指令进行删除，直接生成一个包含花指令的结果。</p>
<p><img src="/2022/03/13/ali/image-20220416214725791.png" alt="image-20220416214725791"></p>
<p>以上述流程为例，这里流程f到流程a实际上是一个假流程，假如采用顺序执行还原，那么就会一直重复abdfabdf这几个部分，那么我们要做的是，建立一个类似栈的东西，将流程存入栈中，同时，这里的栈只包含if流程的初始值(对应if左节点对应的流程参数)，那么栈中的内容就为abdf，如果在碰到a，那么该流程就结束了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Author:  mr2</span></span><br><span class="line"><span class="comment"> * Date:    2022-03-13</span></span><br><span class="line"><span class="comment"> * File:    SwitchFix</span></span><br><span class="line"><span class="comment"> * Project: ast_tools</span></span><br><span class="line"><span class="comment"> *****************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> types = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>).default;</span><br><span class="line"><span class="keyword">const</span> traverse_Switch = &#123;</span><br><span class="line">    <span class="function"><span class="title">ForStatement</span>(<span class="params">path</span>)</span> &#123;</span><br><span class="line">        fix(path)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_other_expression</span>(<span class="params">arr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temparr = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> arr)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!types.isSwitchStatement(i))&#123;</span><br><span class="line">            temparr.push(i);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> temparr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_switch_expression</span>(<span class="params">arr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> arr)&#123;</span><br><span class="line">        <span class="keyword">if</span>(types.isSwitchStatement(i))&#123;</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_switch_obj</span>(<span class="params">SwitchNode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> CaseNode = SwitchNode.cases;</span><br><span class="line">    <span class="keyword">let</span> current_obj = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> CaseNode)&#123;</span><br><span class="line">        <span class="comment">//如果节点里为SwitchStatement</span></span><br><span class="line">        <span class="keyword">if</span>(get_switch_expression(i.consequent))&#123;</span><br><span class="line">            current_obj[i.test.value] = get_switch_obj(get_switch_expression(i.consequent));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            current_obj[i.test.value] = i.consequent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> current_obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">return_obj_create</span>(<span class="params">init_expression, init_params_body</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temparr = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> exp <span class="keyword">of</span> init_params_body)&#123;</span><br><span class="line">        temparr.push(types.objectProperty(types.stringLiteral(exp.declarations[<span class="number">0</span>].id.name), exp.declarations[<span class="number">0</span>].id));</span><br><span class="line">    &#125;;</span><br><span class="line">    temparr.push(types.objectProperty(types.stringLiteral(init_expression.declarations[<span class="number">0</span>].id.name), init_expression.declarations[<span class="number">0</span>].id));</span><br><span class="line">    <span class="keyword">let</span> now_obj = types.objectExpression(temparr);</span><br><span class="line">    <span class="keyword">return</span> now_obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//游走到最底层节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_lowest_node</span>(<span class="params">init_value,SwitchNode, SwitchObj</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//给定初始对象</span></span><br><span class="line">    <span class="keyword">let</span> test_var = SwitchNode.discriminant.name;</span><br><span class="line">    <span class="comment">//获取当前对象的初始值</span></span><br><span class="line">    <span class="keyword">let</span> now_case_value = init_value[test_var];</span><br><span class="line">    <span class="comment">//进入最底层</span></span><br><span class="line">    <span class="keyword">let</span> now_node;</span><br><span class="line">    <span class="keyword">if</span>(types.isSwitchStatement(SwitchNode.cases[now_case_value].consequent[<span class="number">0</span>]))&#123;</span><br><span class="line">        <span class="comment">// console.log(generator(SwitchNode.cases[now_case_value].consequent[0]).code);</span></span><br><span class="line">        now_node = get_lowest_node(init_value, SwitchNode.cases[now_case_value].consequent[<span class="number">0</span>], SwitchObj[now_case_value])</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        now_node = SwitchObj[now_case_value];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> now_node;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于节点游走,为一个递归函数(大变量初始值,对应的SwitchStatement)</span></span><br><span class="line"><span class="comment">//base_var_name:for循环的变量,for循环的值,SwitchNode对应的node节点,init_data 初始化变量,init_var_indentify判断是否停止,SwitchObj游走到底部节点,out_arr用于保存参数,stack用于记录不包含If的所有节点，var_stack用于记录for循环生成的参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_node_expression</span>(<span class="params">base_var_name,value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,stack,var_stack,test_node,for_stament_arr,if_stack</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(!init_var_identify(value)) <span class="keyword">return</span>;</span><br><span class="line">     <span class="keyword">if</span>(if_stack.indexOf(value) &gt; -<span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">     <span class="keyword">let</span> init_value = init_data(value);</span><br><span class="line">     <span class="comment">// console.log(&#x27;开始进行变量初始化&#x27;,init_value, init_var_identify(0));</span></span><br><span class="line">     <span class="comment">// console.log(&#x27;当前base_var_value&#x27;,init_value[base_var_name]);</span></span><br><span class="line">     <span class="keyword">if</span>(for_stament_arr.length &gt; <span class="number">0</span> &amp;&amp; for_stament_arr[for_stament_arr.length-<span class="number">1</span>] == init_value[base_var_name])&#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">let</span> now_arr = get_lowest_node(init_value,SwitchNode,SwitchObj);</span><br><span class="line">     <span class="comment">// console.log(&#x27;当前参数&#x27;,generator(types.blockStatement(stack)).code);</span></span><br><span class="line">     <span class="comment">// console.log(&#x27;当前节点参数&#x27;,generator(types.blockStatement(now_arr)).code);</span></span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> now_arr)&#123;</span><br><span class="line">         <span class="keyword">if</span>(types.isExpressionStatement(i) &amp;&amp; types.isAssignmentExpression(i.expression))&#123;</span><br><span class="line">             <span class="keyword">if</span>(i.expression.left.name == base_var_name)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(i.expression.operator == <span class="string">&#x27;=&#x27;</span>)&#123;</span><br><span class="line">                     get_node_expression(base_var_name,i.expression.right.value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,stack,var_stack,test_node,for_stament_arr,if_stack);</span><br><span class="line">                     <span class="keyword">continue</span>;</span><br><span class="line">                 &#125;;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(types.isBreakStatement(i)) <span class="keyword">continue</span>;</span><br><span class="line">         <span class="keyword">if</span>(!types.isIfStatement(i)) stack.push(i);</span><br><span class="line">         <span class="keyword">if</span>(types.isIfStatement(i))&#123;</span><br><span class="line">             <span class="comment">// console.log(if_stack);</span></span><br><span class="line">             <span class="comment">// console.log(&#x27;当前判断&#x27;,generator(i.test).code);</span></span><br><span class="line">             if_stack.push(value);</span><br><span class="line">             <span class="keyword">let</span> consequentExpression = i.consequent.body[<span class="number">0</span>].expression;</span><br><span class="line">             <span class="keyword">let</span> alternateExpression = i.alternate.body[<span class="number">0</span>].expression;</span><br><span class="line">             <span class="keyword">let</span> if_left_arr = [],if_right_arr = [];</span><br><span class="line">             <span class="keyword">let</span> now_stack = stack.slice(<span class="number">0</span>);</span><br><span class="line">             <span class="comment">//for循环的话不考虑stack</span></span><br><span class="line">             <span class="keyword">if</span>(types.isBinaryExpression(i.test))&#123;</span><br><span class="line">                <span class="keyword">let</span> begin_value = init_data(consequentExpression.right.value)[base_var_name];</span><br><span class="line">                <span class="comment">//传入上一层的value</span></span><br><span class="line">                <span class="keyword">let</span> result_arr = [];</span><br><span class="line">                for_stament_arr.push(init_value[base_var_name])</span><br><span class="line">                <span class="comment">// console.log(&#x27;开始生成for循环,此时节点的值为&#x27;,for_stament_arr);</span></span><br><span class="line">                <span class="keyword">let</span> base_for_test_name = i.test.left.name;</span><br><span class="line">                get_node_expression(base_var_name,begin_value,SwitchNode,init_data,init_var_identify,SwitchObj,result_arr,now_stack,var_stack,base_for_test_name,for_stament_arr,if_stack);</span><br><span class="line">                <span class="comment">// console.log(&#x27;for循环样式:&#x27;,generator(types.forStatement(null,i.test,null,types.blockStatement(result_arr))).code);</span></span><br><span class="line">                <span class="comment">//只有判断表达式的右边类似a.length的形式才计算值</span></span><br><span class="line">                 <span class="keyword">let</span> for_type = types.forStatement(<span class="literal">null</span>, i.test, <span class="literal">null</span>, types.blockStatement(result_arr));</span><br><span class="line">                 out_arr.push(for_type);</span><br><span class="line">                <span class="keyword">let</span> for_end_value = init_data(alternateExpression.right.value)[base_var_name];</span><br><span class="line">                <span class="comment">// console.log(&#x27;else节点value&#x27;,for_end_value,&#x27;开始进入else节点&#x27;);</span></span><br><span class="line">                for_stament_arr.pop();</span><br><span class="line">                <span class="keyword">let</span> else_result_arr = [];</span><br><span class="line">                get_node_expression(base_var_name,for_end_value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,now_stack,var_stack,test_node,for_stament_arr,if_stack);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//进入if节点的内部的时候,要传入上一层入口处的流程参数，然后在到该部分的时候，退出if节点</span></span><br><span class="line">             <span class="comment">//递归计算左节点</span></span><br><span class="line">             <span class="keyword">let</span> left_stack=if_stack.slice(<span class="number">0</span>),right_stack=if_stack.slice(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">             <span class="comment">// console.log(&#x27;开始进入&#x27;+generator(i.test).code+&#x27;左节点&#x27;);</span></span><br><span class="line">             get_node_expression(base_var_name, consequentExpression.right.value, SwitchNode, init_data, init_var_identify, SwitchObj, if_left_arr, now_stack, var_stack, test_node, for_stament_arr, left_stack);</span><br><span class="line">             <span class="comment">//递归计算右节点</span></span><br><span class="line">             <span class="comment">// console.log(&#x27;开始进入&#x27;+generator(i.test).code+&#x27;右节点&#x27;);</span></span><br><span class="line">             get_node_expression(base_var_name, alternateExpression.right.value, SwitchNode, init_data, init_var_identify, SwitchObj, if_right_arr, now_stack, var_stack, test_node, for_stament_arr, right_stack);</span><br><span class="line">             out_arr.push(types.ifStatement(i.test, types.blockStatement(if_left_arr), types.blockStatement(if_right_arr)));</span><br><span class="line">             <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">         <span class="keyword">if</span>(out_arr) out_arr.push(i);</span><br><span class="line">         <span class="keyword">if</span>(types.isReturnStatement(i)) <span class="keyword">return</span>;</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fix</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;init,test,update,body&#125; = path.node;</span><br><span class="line">    <span class="keyword">if</span>(update) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(!init) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> init_params_body = get_other_expression(body.body);</span><br><span class="line">    <span class="keyword">let</span> return_obj_statement = return_obj_create(init, init_params_body);</span><br><span class="line">    init_params_body.push(types.returnStatement(return_obj_statement));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将初始化的值eval进内存.后续可以直接调用</span></span><br><span class="line">    <span class="built_in">eval</span>(generator(types.functionDeclaration(types.identifier(<span class="string">&#x27;init_var_identify&#x27;</span>),</span><br><span class="line">        [init.declarations[<span class="number">0</span>].id],</span><br><span class="line">        types.blockStatement([types.returnStatement(test)])</span><br><span class="line">        )).code);</span><br><span class="line">    <span class="built_in">eval</span>(generator(types.functionDeclaration(types.identifier(<span class="string">&#x27;init_data&#x27;</span>),</span><br><span class="line">        [init.declarations[<span class="number">0</span>].id],</span><br><span class="line">        types.blockStatement(init_params_body)</span><br><span class="line">        )).code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> SwitchNode = get_switch_expression(body.body);</span><br><span class="line">    <span class="keyword">let</span> SwitchObj = get_switch_obj(SwitchNode);</span><br><span class="line">    <span class="keyword">let</span> out_arr = [],stack=[],for_stament_arr=[],if_stack=[];</span><br><span class="line">    get_node_expression(init.declarations[<span class="number">0</span>].id.name,init.declarations[<span class="number">0</span>].init.value,SwitchNode,init_data,init_var_identify,SwitchObj,out_arr,[],stack,&#123;&#125;,for_stament_arr,if_stack);</span><br><span class="line">    <span class="comment">// console.log(out_arr);</span></span><br><span class="line">    path.replaceWithMultiple(out_arr);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.fix = traverse_Switch;</span><br></pre></td></tr></table></figure>
<p>以这种思路会有致命的弊端，他的if流程越多，那么所需要的内存越大，如果有1000个if，那么空间复杂度就是2^1000，一般电脑带不动，会直接爆内存不足。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">ast_tools解读</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> ast_tools源码解读</p>
<h4 id="IfWithExpressFix"><a href="#IfWithExpressFix" class="headerlink" title="IfWithExpressFix"></a>IfWithExpressFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311193502748.png" alt="image-20220311193502748"></p>
<p>主要是给不包含block的if表达式添加上，让其统一化。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a=<span class="number">1</span>) <span class="keyword">var</span> b=<span class="number">3</span>;</span><br><span class="line">-----------------</span><br><span class="line"><span class="keyword">if</span>(a=<span class="number">1</span>)&#123;<span class="keyword">var</span> b=<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ForWithExpressFix-amp-ForWithForFix"><a href="#ForWithExpressFix-amp-ForWithForFix" class="headerlink" title="ForWithExpressFix &amp; ForWithForFix"></a>ForWithExpressFix &amp; ForWithForFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311193754270.png" alt="image-20220311193754270"></p>
<p>都是给For循环规范化。</p>
<h4 id="ReturnSeqFix"><a href="#ReturnSeqFix" class="headerlink" title="ReturnSeqFix"></a>ReturnSeqFix</h4><p>将return中包含逗号表达式的还原</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311194547853.png" alt="image-20220311194547853"></p>
<p>第一部分用于将所有的逗号表达式添加到数组中，第二步主要是将逗号表达式前n-1项加到return前面，然后将return节点只包含逗号表达式的最后一项。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;<span class="keyword">return</span> c=a+<span class="number">1</span>,b&#125;</span><br><span class="line">--------------------------</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;c=a+<span class="number">1</span>;<span class="keyword">return</span> ab&#125;</span><br></pre></td></tr></table></figure>
<h4 id="VariableDeclaratorFix"><a href="#VariableDeclaratorFix" class="headerlink" title="VariableDeclaratorFix"></a>VariableDeclaratorFix</h4><p>声明表达式及赋值表达式还原。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a,b,c;</span><br><span class="line">m=<span class="number">2</span>,d=<span class="number">3</span>,n=<span class="number">4</span>;</span><br><span class="line">-----------</span><br><span class="line"><span class="keyword">var</span> a;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"><span class="keyword">var</span> c;</span><br><span class="line">m=<span class="number">2</span>;</span><br><span class="line">d=<span class="number">3</span>;</span><br><span class="line">n=<span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ConditionalFix"><a href="#ConditionalFix" class="headerlink" title="ConditionalFix"></a>ConditionalFix</h4><p>三目表达式转化为if-else的形式。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200057628.png" alt="image-20220311200057628"></p>
<h4 id="SequenceExpressionFix"><a href="#SequenceExpressionFix" class="headerlink" title="SequenceExpressionFix"></a>SequenceExpressionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200313589.png" alt="image-20220311200313589"></p>
<p>本质上还是逗号表达式的还原。</p>
<h4 id="AssignmentWithConditionalFix"><a href="#AssignmentWithConditionalFix" class="headerlink" title="AssignmentWithConditionalFix"></a>AssignmentWithConditionalFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200459670.png" alt="image-20220311200459670"></p>
<p>还是对三目表达的还原，这里限制了其consequent和alternate部分都为数字。</p>
<h4 id="LogicalExpressionFix"><a href="#LogicalExpressionFix" class="headerlink" title="LogicalExpressionFix"></a>LogicalExpressionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311200832831.png" alt="image-20220311200832831"></p>
<p>将逻辑表达式转化为条件表达式。</p>
<h4 id="UnaryFunctionFix"><a href="#UnaryFunctionFix" class="headerlink" title="UnaryFunctionFix"></a>UnaryFunctionFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311201334471.png" alt="image-20220311201334471"></p>
<p>把自执行函数的壳去掉。</p>
<h4 id="ControlFlowFix"><a href="#ControlFlowFix" class="headerlink" title="ControlFlowFix"></a>ControlFlowFix</h4><p>控制流平坦化。</p>
<ul>
<li><p>进入大FOR循环，获取第一个初始化Ci的表达式，然后根据一个三目获取变量的名称(其余的条件貌似不是针对大控制流的)。</p>
</li>
<li><p>定义了两个数组，分别用于存取大控制流的变量</p>
</li>
</ul>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311203909800.png" alt="image-20220311203909800"></p>
<ul>
<li><p>生成了一个函数，给定一个初始的li然后会返回一个字典包含这五个参数。</p>
</li>
<li><p>进入控制流，然后生产了一个用于判断是否结束的函数。</p>
</li>
<li><p>获取主流程switch节点</p>
</li>
<li>初始化了get_control_struct函数，steps_hash_list，bodys，get_next_control_param函数，</li>
<li>定义了一个get_node函数(控制流的另一种形式，初始li参数)</li>
</ul>
<blockquote>
<p>控制流的另一种形式：将上述控制流转化为一个类似字典的东西，键指代控制流指向，值包含其内容为node类型。</p>
</blockquote>
<h5 id="get-code函数"><a href="#get-code函数" class="headerlink" title="get_code函数"></a>get_code函数</h5><p>控制流的整体流程</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311210310953.png" alt="image-20220311210310953"></p>
<p>这里获取所有初始参数的值</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311210631798.png" alt="image-20220311210631798"></p>
<p>这一步应该是不断计算，获取最下层节点即Ai节点的值。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311211105814.png" alt="image-20220311211105814"></p>
<p>在这里，由于包含IF的模块，所以还要对其进行一个判断，get_next_control_param用于获取其类型是否包含这种IF。</p>
<p>向栈中添加这两个节点值。</p>
<p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311211853434.png" alt="image-20220311211853434"></p>
<p>然后根据这个11490在进行一个这个流程，在进入while流程中，基本上就将控制流还原了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ba = <span class="built_in">window</span>;</span><br><span class="line">Nt = r;</span><br><span class="line">ur = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">Jo = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">ei = O;</span><br><span class="line"><span class="keyword">if</span> (Nt) &#123;</span><br><span class="line">。。。。</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>整体思想，获取初始参数的值，计算出中间参数的值，找到最底层的节点，获取当前节点的表达式，然后获取下一步初始参数的值(要对for循环中的条件进行一个判断)，反复调用并合并节点，最后将整个大FOR循环脱掉。</p>
</blockquote>
<h4 id="ConstantFix"><a href="#ConstantFix" class="headerlink" title="ConstantFix"></a>ConstantFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311220545744.png" alt="image-20220311220445933"></p>
<p>字符串的还原。</p>
<h4 id="DecryptVariableFix"><a href="#DecryptVariableFix" class="headerlink" title="DecryptVariableFix"></a>DecryptVariableFix</h4><p>将w.pop()的形式，还原为字符串。</p>
<h4 id="ReserveStrFix"><a href="#ReserveStrFix" class="headerlink" title="ReserveStrFix"></a>ReserveStrFix</h4><p><img src="/2022/03/11/ast-tools%E8%A7%A3%E8%AF%BB/image-20220311215701659.png" alt="image-20220311215701659"></p>
<p>这玩意的还原。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/07/rs4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/07/rs4/" class="post-title-link" itemprop="url">rs4</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="RS4"><a href="#RS4" class="headerlink" title="RS4"></a>RS4</h4><p>进入其代码中，可以发现，充斥着大量的IF-ELSE流，干扰分析，让人头痛。</p>
<p><img src="/2022/03/07/rs4/image-20220307225925441.png" alt="image-20220307225925441"></p>
<p>通过观察发现，这里面虽然充斥大量的IF-ELSE流，但是跟进去就会发现，它每一个区域块都对应了其IF提到的值-1，最后的那个_$yZ(767,3)其实对应的是255这个值的流程。</p>
<p><img src="/2022/03/07/rs4/image-20220307230312062.png" alt="image-20220307230312062"></p>
<p>用Babel解析IFstatement，会得到三部分：</p>
<ul>
<li>test: 上述 _$pp &lt; 255的验证部分</li>
<li>consequent: BlockStatement 对应 后面的{}区域</li>
<li>alternate:else后跟的{}区域</li>
</ul>
<p>编写如下插件，将其转化为Switch-case的形式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIfnode</span>(<span class="params">testNode,consequentNode, alternateNode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> currentvalue = testNode.right.value;</span><br><span class="line">    <span class="keyword">if</span>(types.isIfStatement(consequentNode.body[<span class="number">0</span>]) &amp;&amp; types.isBinaryExpression(consequentNode.body[<span class="number">0</span>].test))&#123;</span><br><span class="line">        getIfnode(consequentNode.body[<span class="number">0</span>].test,consequentNode.body[<span class="number">0</span>].consequent, consequentNode.body[<span class="number">0</span>].alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isBlockStatement(alternateNode) &amp;&amp; types.isIfStatement(alternateNode.body[<span class="number">0</span>]) &amp;&amp; types.isBinaryExpression(alternateNode.body[<span class="number">0</span>].test))&#123;</span><br><span class="line">        getIfnode(alternateNode.body[<span class="number">0</span>].test,alternateNode.body[<span class="number">0</span>].consequent, alternateNode.body[<span class="number">0</span>].alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isIfStatement(alternateNode))&#123;</span><br><span class="line">        getIfnode(alternateNode.test,alternateNode.consequent, alternateNode.alternate);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(!types.isIfStatement(consequentNode.body[<span class="number">0</span>]))&#123;</span><br><span class="line">        fullNode[currentvalue-<span class="number">1</span>] = consequentNode.body[<span class="number">0</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(types.isBlockStatement(alternateNode) &amp;&amp; !types.isIfStatement(alternateNode.body[<span class="number">0</span>]))&#123;</span><br><span class="line">        fullNode[currentvalue] = alternateNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> all_func_list = [<span class="string">&#x27;_$pp&#x27;</span>, <span class="string">&#x27;_$XF&#x27;</span>, <span class="string">&#x27;_$by&#x27;</span>, <span class="string">&#x27;_$Wi&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> fullNode = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> If2Switch = &#123;</span><br><span class="line">    <span class="function"><span class="title">IfStatement</span>(<span class="params">path</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;test, consequent, alternate&#125; = path.node;</span><br><span class="line">        <span class="keyword">if</span> (!types.isBinaryExpression(test) || !types.isIdentifier(test.left) || test.operator !== <span class="string">&#x27;&lt;&#x27;</span> || !types.isNumericLiteral(test.right)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">let</span> Ifun_name = test.left.name;</span><br><span class="line">        <span class="keyword">if</span>(all_func_list.indexOf(Ifun_name) == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        getIfnode(test, consequent, alternate);</span><br><span class="line">        <span class="keyword">let</span> swichcasearr = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> fullNode)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fullNode[i] !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(types.isBlockStatement(fullNode[i]))&#123;</span><br><span class="line">                     swichcasearr.push(types.switchCase(types.valueToNode(i), fullNode[i].body));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    swichcasearr.push(types.switchCase(types.valueToNode(i), [fullNode[i]]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                swichcasearr.push(types.switchCase(types.valueToNode(i), []));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        path.replaceWith(types.switchStatement(types.identifier(Ifun_name), swichcasearr));</span><br><span class="line">        fullNode = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过进一步观察，发现代码中_$lE反复出现，且其调用为字面量，</p>
<p><img src="/2022/03/07/rs4/image-20220308202132866.png" alt="image-20220308202132866"></p>
<p><img src="/2022/03/07/rs4/image-20220308202141280.png" alt="image-20220308202141280"></p>
<p>因此，该参数可以作为一个还原参数，接下来就是去寻找这个参数在哪生成，</p>
<p><img src="/2022/03/07/rs4/image-20220308202244145.png" alt="image-20220308202244145"></p>
<p>除了初始化部分，该参数只在这里出现，我们发现在上述数组初始化的时候，初始化了_$Ei，然后$Ei又在下面进行了修改啥的，先把这部分抠出来作为环境。</p>
<p>然后把这个数组以及另一个解密函数对其还原，发现基本上能看了，但是在这串代码中，</p>
<p><img src="/2022/03/07/rs4/image-20220308205506033.png" alt="image-20220308205506033"></p>
<p>红框标注的代码应该是之前生成的，所以，要针对其进行还原的话，还得把这里给东西抠出来。</p>
<h5 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h5><p>首先重新进入网站，打上script断点，发现定义了scj，和一个长数组</p>
<p><img src="/2022/03/07/rs4/image-20220308220816827.png" alt="image-20220308220816827"></p>
<p>跟下去会进入一段页面自带的js，跳过去发现scj还是没有生成，但是却多了一些字符和函数啥的，同时上一步提到的aebi已经生成了。    </p>
<p><img src="/2022/03/07/rs4/image-20220308221247264.png" alt="image-20220308221247264"></p>
<p>也就是说，在这一步，应该会生成许多东西，接下来，将这个js扣下来对其进行还原。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yida506.github.io/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spider">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/" class="post-title-link" itemprop="url">知乎vmp</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>449</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="知乎"><a href="#知乎" class="headerlink" title="知乎"></a>知乎</h4><p>加密参数：x-zse-96</p>
<p>插桩位置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;索引：&quot;</span>, <span class="built_in">this</span>.C, <span class="string">&quot; 值：&quot;</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">key, value</span>) </span>&#123;<span class="keyword">if</span> (value == <span class="built_in">window</span>) &#123;<span class="keyword">return</span> <span class="literal">undefined</span>&#125; <span class="keyword">return</span> value&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/06/%E7%9F%A5%E4%B9%8Evmp/image-20220306141125895.png" alt="image-20220306141125895"></p>
<p><strong>大字符串</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlist = <span class="string">&quot;RuPtXwxpThIZ0qyz_9fYLCOV8B1mMGKs7UnFHgN3iDaWAJE-Qrk2ecSo6bjd4vl5&quot;</span></span><br></pre></td></tr></table></figure>
<p>这里面的参数都是由这个大字符串通过索引的方式生成的。</p>
<p>据说生成的签名参数为4个一组。</p>
<p>该处生成的签名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;a_F8Fguqc0Yxo0NqzBOykiUBSLYfnGF8z9Y8SAeqQ0xp&#x27;</span></span><br></pre></td></tr></table></figure>
<p>个人认为，要分析如上内容，首先要知道，它是靠什么生成的数，其次是要知道，在生成第一次数了，后面的流程是什么，紧接着是要知道哪些流程是采取的固定的计算方法，这样就可以把其算法复现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lan</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">163k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">2:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
